<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&G's - Construction Estimator</title>
    
    <!-- Firebase Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>
    
    <!-- Shared JavaScript Files -->
    <script src="js/firebase-config.js"></script>
    <script src="js/client-manager.js"></script>
    <script src="js/module-utils.js"></script>
    <script src="js/data-models.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        .sidebar {
            width: 25%;
            background-color: #1c2639;
            color: #fff;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid #333;
        }

        .main-content {
            width: 75%;
            height: 100%;
            overflow: hidden;
            background-color: white;
            color: #333;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.4em;
            font-weight: bold;
            border-bottom: 1px solid #333;
        }

        .section-title {
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .module-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            background-color: #1c2639;
            color: #fff;
        }

        .module-title {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .module-title i {
            margin-right: 10px;
        }

        .module-description {
            padding: 10px 20px;
            color: #aaa;
            background-color: #1c2639;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .module-content {
            padding: 20px;
            background-color: #fff;
            margin: 0;
            color: #333;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom scrollbar styling */
        .module-content::-webkit-scrollbar {
            width: 8px;
            background-color: #f5f5f5;
        }

        .module-content::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 4px;
        }

        .module-content::-webkit-scrollbar-thumb:hover {
            background-color: #888;
        }

        .sidebar-content {
            padding: 20px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .sidebar-item {
            padding: 10px;
            cursor: pointer;
            background-color: #2d364a;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .sidebar-item:hover {
            background-color: #3a4967;
        }

        .sidebar-link {
            color: #fff;
            text-decoration: none;
            display: block;
        }

        .btn {
            background-color: #4eca8b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #3db97a;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Custom scrollbar styling for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
            background-color: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Table styles */
        .module-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed; /* Added for fixed column widths */
        }

        .module-table th, 
        .module-table td {
            padding: 12px 10px; /* Increased vertical padding for larger text */
            text-align: left;
            border: 1px solid #ddd;
            overflow: hidden; /* Prevent content from breaking layout */
        }

        /* Increased description text size */
        .module-table td:first-child input,
        .module-table .description-input {
            font-size: 1.1em;  /* Increase from default size */
            font-weight: 500;  /* Slightly bolder than normal */
        }

        /* Column width adjustments for P&G's */
        .module-table th:nth-child(1),
        .module-table td:nth-child(1) {
            width: 40%; /* Description column */
        }

        .module-table th:nth-child(2),
        .module-table td:nth-child(2) {
            width: 5%; /* Pc column */
            text-align: center;
        }

        .module-table th:nth-child(3),
        .module-table td:nth-child(3) {
            width: 10%; /* Qty column */
            text-align: center;
        }

        .module-table th:nth-child(4),
        .module-table td:nth-child(4) {
            width: 15%; /* Rate column */
            text-align: right;
        }

        .module-table th:nth-child(5),
        .module-table td:nth-child(5) {
            width: 10%; /* Unit column */
            text-align: center;
        }

        .module-table th:nth-child(6),
        .module-table td:nth-child(6) {
            width: 15%; /* Total column */
            text-align: right;
        }

        .module-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: relative;
        }

        .module-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .module-table tr:hover {
            background-color: #f1f1f1;
        }

        .module-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid transparent;
            background-color: transparent;
        }

        .module-table input:focus {
            border: 1px solid #4eca8b;
            background-color: #fff;
            outline: none;
        }

        .module-table input[type="number"] {
            text-align: right;
        }

        .module-table .currency {
            text-align: right;
        }

        .module-table .footer-row {
            font-weight: bold;
            background-color: #e9e9e9;
        }

        .module-table .qty-cell {
            background-color: #f0faf3;
        }

        /* Checkbox styles */
        .checkbox-cell {
            text-align: center;
        }
        
        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Save status indicator */
        #save-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
            transition: opacity 0.3s;
        }

        /* Addition buttons */
        .add-item-btn {
            margin-top: 10px;
            display: inline-block;
        }

        /* Headers with sort arrows */
        .sort-header {
            cursor: pointer;
        }

        .sort-header::after {
            content: "▼";
            font-size: 0.8em;
            margin-left: 5px;
            opacity: 0.3;
        }

        .sort-header.sorted-asc::after {
            content: "▲";
            opacity: 1;
        }

        .sort-header.sorted-desc::after {
            content: "▼";
            opacity: 1;
        }
        
        /* Debug panel for troubleshooting */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">P&G's</div>
        
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="return-to-dashboard">Return to Dashboard</a>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Actions</div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="add-custom-item">Add Custom Item</a>
                </div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="save-module-data">Save Data</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="module-header">
            <div class="module-title">
                <i>P</i> <span id="module-title-text">P&G's</span>
            </div>
            <div id="client-name-display" style="margin-left: 20px;"></div>
            <div class="header-actions">
                <div id="total-module-cost">
                    Total P&G's Cost: R0.00
                </div>
            </div>
        </div>

        <div class="module-description">
            <div style="display: flex; justify-content: flex-end; align-items: center; width: 100%;">
                <div id="save-status"></div>
                <button id="save-btn" class="btn">Save</button>
                <button id="return-btn" class="btn btn-secondary" style="margin-left: 10px;">Return to Dashboard</button>
            </div>
        </div>

        <div class="module-content">
            <table class="module-table" id="items-table">
                <thead>
                    <tr>
                        <th class="sort-header" data-sort="description">P&G's</th>
                        <th>Pc</th>
                        <th class="sort-header" data-sort="qty">Qty</th>
                        <th class="sort-header" data-sort="rate">Rate</th>
                        <th>Unit</th>
                        <th class="sort-header" data-sort="total">Total</th>
                    </tr>
                </thead>
                <tbody id="items-table-body">
                    <!-- Items will be added here dynamically -->
                </tbody>
                <tfoot>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Total</td>
                        <td class="currency" id="table-total">R0.00</td>
                    </tr>
                </tfoot>
            </table>
            
            <button id="add-item-btn" class="btn add-item-btn">Add Custom Item</button>
        </div>
    </div>
    
    <!-- Debug panel for troubleshooting -->
    <div class="debug-panel" id="debug-panel"></div>

    <script>
        // Module settings - CUSTOMIZED FOR P&G'S MODULE
        const MODULE = {
            id: 'p-and-gs', // Module ID matching filename
            title: 'P&G\'s', // Module title
            defaultItems: [  // P&G default items from screenshot
                { id: 'contracts-manager', description: 'Contracts manager as required', rate: 6500.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'site-agent', description: 'Site Agent', rate: 8500.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'architect', description: 'Architect - Snag List', rate: 2500.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'deliveries', description: 'Deliveries', rate: 0.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'phones', description: 'Phones / radios', rate: 500.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'vehicle', description: 'Vehicle & Petrol', rate: 1000.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'site-office', description: 'Site Office', rate: 1250.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'site-container', description: 'Site Container', rate: 750.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'toilet-subbies', description: 'Temp. Chemical Toilet Subbies', rate: 400.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'toilet-manager', description: 'Temp. Chemical Toilet Manager', rate: 400.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'electrical-connection', description: 'Temp. Electrical connection', rate: 7500.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'electrical-usage', description: 'Temporary Electrical usage', rate: 100.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'fencing', description: 'Temporary Fencing', rate: 300.00, unit: 'm', checked: false, qty: 0, isDefault: true },
                { id: 'water-connection', description: 'Water Supply connection', rate: 5000.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'water-usage', description: 'Water usage', rate: 150.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'head-office', description: 'Head Office Overheads', rate: 1000.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'insurances', description: 'Insurances', rate: 12500.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'land-surveyor', description: 'Land Surveyor', rate: 12000.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'health-safety-file', description: 'Health & safety file', rate: 7000.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'health-safety-visits', description: 'Health & safety visits', rate: 2500.00, unit: 'Months', checked: false, qty: 0, isDefault: true },
                { id: 'site-board', description: 'Site Board', rate: 5500.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'hoa-deposit', description: 'HOA/Builders Deposit', rate: 15000.00, unit: '1', checked: false, qty: 0, isDefault: true },
                { id: 'rubble-removal', description: 'General Rubble Removal', rate: 1700.00, unit: 'Weeks', checked: false, qty: 0, isDefault: true },
                { id: 'builders-clean', description: 'Builders Clean at End', rate: 7500.00, unit: '1', checked: false, qty: 0, isDefault: true }
            ]
        };
        
        // Module data structure
        let moduleData = {
            items: [],
            totalCost: 0,
            lastModified: new Date().toISOString()
        };
        
        // Auto-save cancel function
        let cancelAutoSave = null;
        
        // Debug flag - set to true to enable debug panel
        const DEBUG = true;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`[${MODULE.id}] DOM loaded, initializing module`);
            
            // Set up debug panel if needed
            if (DEBUG) {
                setupDebugPanel();
            }
            
            // Update module title everywhere
            updateModuleTitles();
            
            // Check module access - ensure we came from dashboard
            const validAccess = window.ConstructionApp.ModuleUtils.checkModuleAccess();
            if (!validAccess) {
                console.log(`[${MODULE.id}] Invalid access detected, redirecting`);
                return; // ModuleUtils will handle the redirect
            }
            
            // Get the current client
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            if (!client) {
                console.error(`[${MODULE.id}] No client available, returning to dashboard`);
                window.ConstructionApp.ModuleUtils.returnToDashboard();
                return;
            }
            
            // Update client name display
            document.getElementById('client-name-display').textContent = `Client: ${client.name}`;
            
            // Initialize save status indicator
            window.ConstructionApp.ModuleUtils.initSaveStatus('save-status');
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize module data
            initModuleData();
            
            // Set up change tracking
            window.ConstructionApp.ModuleUtils.setupChangeTracking('.module-table');
            
            // Set up auto-save (2 minutes interval)
            cancelAutoSave = window.ConstructionApp.ModuleUtils.setupAutoSave(saveModuleData, 2 * 60 * 1000);
            
            // Set up sorting
            setupTableSorting();
            
            // Update debug panel if enabled
            if (DEBUG) {
                updateDebugPanel();
            }
        });
        
        // Update module titles across the UI
        function updateModuleTitles() {
            document.title = `${MODULE.title} - Construction Estimator`;
            document.querySelector('.sidebar-header').textContent = MODULE.title;
            document.getElementById('module-title-text').textContent = MODULE.title;
            document.getElementById('total-module-cost').textContent = `Total ${MODULE.title} Cost: R0.00`;
        }
        
        // Initialize module data from client
        function initModuleData() {
            // Get client
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            
            // Check if we have saved data for this module
            const savedData = client.moduleData?.[MODULE.id] || null;
            
            if (savedData) {
                // Restore saved data
                console.log(`[${MODULE.id}] Restoring saved data`);
                moduleData = savedData;
                
                // Ensure items array exists
                if (!moduleData.items || !Array.isArray(moduleData.items)) {
                    moduleData.items = [];
                }
                
                // Merge with default items to ensure all required items exist
                mergeWithDefaultItems();
                
                // Update UI with saved data
                updateUI();
            } else {
                console.log(`[${MODULE.id}] No saved data found, using defaults`);
                // Try to use data-models default P&Gs items if available
                if (window.ConstructionApp.DataModels && window.ConstructionApp.DataModels.getPAndGsItems) {
                    moduleData.items = window.ConstructionApp.DataModels.getPAndGsItems();
                    console.log(`[${MODULE.id}] Loaded items from DataModels:`, moduleData.items.length);
                } else {
                    // Initialize with default items from this module
                    moduleData.items = JSON.parse(JSON.stringify(MODULE.defaultItems)); // Deep copy
                    console.log(`[${MODULE.id}] Loaded default items:`, moduleData.items.length);
                }
                updateUI();
            }
        }
        
        // Merge saved items with default items
        function mergeWithDefaultItems() {
            // Use DataModels utility if available
            if (window.ConstructionApp.DataModels && window.ConstructionApp.DataModels.mergeWithDefaults && window.ConstructionApp.DataModels.getPAndGsItems) {
                moduleData.items = window.ConstructionApp.DataModels.getPAndGsItems(moduleData.items);
                return;
            }
            
            // Fallback to manual merge
            // Create a map of saved items by ID
            const savedItemsMap = {};
            moduleData.items.forEach(item => {
                if (item.id) {
                    savedItemsMap[item.id] = item;
                }
            });
            
            // Create a new array with default items, but use saved values if they exist
            const mergedItems = [];
            
            // First add all default items (with saved values if available)
            MODULE.defaultItems.forEach(defaultItem => {
                if (savedItemsMap[defaultItem.id]) {
                    // Item exists in saved data, use it but ensure required properties exist
                    const savedItem = savedItemsMap[defaultItem.id];
                    mergedItems.push({
                        ...defaultItem,
                        ...savedItem,
                        // These properties should always match the default
                        description: defaultItem.description,
                        unit: defaultItem.unit,
                        rate: defaultItem.rate,
                        isDefault: true
                    });
                    // Remove from map so we know it's been processed
                    delete savedItemsMap[defaultItem.id];
                } else {
                    // Item doesn't exist in saved data, use default
                    mergedItems.push({...defaultItem});
                }
            });
            
            // Then add any custom items that weren't in the defaults
            for (const id in savedItemsMap) {
                if (savedItemsMap[id].custom) {
                    mergedItems.push(savedItemsMap[id]);
                }
            }
            
            // Update module data
            moduleData.items = mergedItems;
        }
        
        // Update UI with current module data
        function updateUI() {
            const tableBody = document.getElementById('items-table-body');
            tableBody.innerHTML = ''; // Clear existing rows
            
            // Add each item
            moduleData.items.forEach(item => {
                addTableRow(item);
            });
            
            // Update totals
            calculateTotals();
            
            // Update debug panel if enabled
            if (DEBUG) {
                updateDebugPanel();
            }
        }
        
        // Add a row to the table
        function addTableRow(item) {
            const tableBody = document.getElementById('items-table-body');
            const row = document.createElement('tr');
            row.setAttribute('data-item-id', item.id);
            
            // Format currency
            const rateFormatted = window.ConstructionApp.ModuleUtils.formatCurrency(item.rate);
            const totalFormatted = window.ConstructionApp.ModuleUtils.formatCurrency(
                item.qty > 0 ? (item.qty * item.rate) : 0
            );
            
            // Create row content - kept the Pc checkbox for reference only
            row.innerHTML = `
                <td>
                    <input type="text" class="description-input" value="${item.description}" 
                           ${item.isDefault ? 'readonly' : ''}>
                </td>
                <td class="checkbox-cell">
                    <input type="checkbox" class="item-checkbox" ${item.checked ? 'checked' : ''}>
                </td>
                <td class="qty-cell">
                    <input type="number" class="qty-input" value="${item.qty}" min="0" step="1">
                </td>
                <td>
                    <input type="text" class="rate-input currency" value="${rateFormatted}" 
                           ${item.isDefault ? 'readonly' : ''}>
                </td>
                <td>
                    ${item.unit}
                </td>
                <td class="total-cell currency">${totalFormatted}</td>
            `;
            
            tableBody.appendChild(row);
            
            // Add event listeners to inputs
            setupRowInputHandlers(row);
        }
        
        // Set up input handlers for a row
        function setupRowInputHandlers(row) {
            // Description input
            const descInput = row.querySelector('.description-input');
            if (descInput) {
                descInput.addEventListener('input', function() {
                    updateItemFromRow(row);
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                });
            }
            
            // Checkbox input - for reference only, doesn't affect calculation
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    updateItemFromRow(row);
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                });
            }
            
            // Quantity input - this affects the calculation
            const qtyInput = row.querySelector('.qty-input');
            if (qtyInput) {
                qtyInput.addEventListener('input', function() {
                    updateItemFromRow(row);
                    calculateRowTotal(row);
                    calculateTotals();
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                });
            }
            
            // Rate input
            const rateInput = row.querySelector('.rate-input');
            if (rateInput) {
                rateInput.addEventListener('focus', function() {
                    // When focusing, show raw number for editing
                    this.value = getNumericValue(this.value);
                });
                
                rateInput.addEventListener('blur', function() {
                    // When losing focus, format as currency
                    const numericValue = getNumericValue(this.value);
                    this.value = window.ConstructionApp.ModuleUtils.formatCurrency(numericValue);
                    updateItemFromRow(row);
                    calculateRowTotal(row);
                    calculateTotals();
                });
                
                rateInput.addEventListener('input', function() {
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                });
            }
        }
        
        // Update item data from row inputs
        function updateItemFromRow(row) {
            const itemId = row.getAttribute('data-item-id');
            const item = moduleData.items.find(i => i.id === itemId);
            
            if (item) {
                // Get values from inputs
                const descInput = row.querySelector('.description-input');
                const checkbox = row.querySelector('.item-checkbox');
                const qtyInput = row.querySelector('.qty-input');
                const rateInput = row.querySelector('.rate-input');
                
                if (descInput && !item.isDefault) {
                    item.description = descInput.value;
                }
                
                if (checkbox) {
                    item.checked = checkbox.checked; // Store checkbox state for reference
                }
                
                if (qtyInput) {
                    item.qty = parseInt(qtyInput.value) || 0;
                }
                
                if (rateInput && !item.isDefault) {
                    item.rate = getNumericValue(rateInput.value);
                }
            }
        }
        
        // Calculate total for a row - based on qty only, not checkbox
        function calculateRowTotal(row) {
            const itemId = row.getAttribute('data-item-id');
            const item = moduleData.items.find(i => i.id === itemId);
            
            if (item) {
                // Include in total if quantity > 0 (checkbox doesn't affect this)
                const total = item.qty > 0 ? (item.qty * item.rate) : 0;
                const totalCell = row.querySelector('.total-cell');
                
                if (totalCell) {
                    totalCell.textContent = window.ConstructionApp.ModuleUtils.formatCurrency(total);
                }
                
                return total;
            }
            
            return 0;
        }
        
        // Calculate all totals and update module data - based on qty only
        function calculateTotals() {
            let totalCost = 0;
            
            // Sum all item totals (only items with qty > 0, regardless of checkbox)
            moduleData.items.forEach(item => {
                if (item.qty > 0) {
                    totalCost += item.qty * item.rate;
                }
            });
            
            // Update module data
            moduleData.totalCost = totalCost;
            
            // Update UI
            document.getElementById('table-total').textContent = 
                window.ConstructionApp.ModuleUtils.formatCurrency(totalCost);
            
            document.getElementById('total
