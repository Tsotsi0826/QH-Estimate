<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/client-manager.js"></script>
    <script src="js/module-utils.js"></script>
    <script src="js/data-models.js"></script>
    <style>
        /* --- DARK THEME UPDATE --- */

        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif; /* Consider a more modern font later if desired */
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #111827; /* --- Dark background for body --- */
        }

        /* Sidebar Styles (Mostly unchanged, already dark) */
        .sidebar {
            width: 25%;
            min-width: 250px;
            background-color: #1f2937; /* --- Slightly lighter dark blue/gray --- */
            color: #d1d5db; /* --- Light gray text --- */
            height: 100%;
            border-right: 1px solid #374151; /* --- Darker border --- */
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.4em;
            font-weight: 600; /* Slightly bolder */
            border-bottom: 1px solid #374151; /* --- Darker border --- */
            flex-shrink: 0;
            color: #f9fafb; /* --- White header text --- */
        }

        .section-title {
            padding: 15px 20px 10px 20px; /* Adjust padding */
            font-size: 0.9em; /* Smaller section title */
            font-weight: 600;
            text-transform: uppercase; /* Uppercase */
            color: #9ca3af; /* --- Medium gray --- */
            flex-shrink: 0;
        }

        .client-actions {
            padding: 0 20px;
            flex-shrink: 0;
        }

        .client-action {
            display: flex;
            align-items: center;
            padding: 10px; /* Consistent padding */
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px; /* Space between actions */
            transition: background-color 0.2s, color 0.2s;
            color: #d1d5db; /* Default light gray */
        }

        .client-action i {
            margin-right: 10px;
            font-style: normal;
            width: 1.2em; /* Slightly wider */
            text-align: center;
            color: #9ca3af; /* Icon color */
        }

        .client-action:hover {
            background-color: #374151; /* --- Darker hover --- */
            color: #ffffff; /* --- White text on hover --- */
        }
         .client-action:hover i {
             color: #4eca8b; /* Accent color on hover */
         }


        .search-container {
            padding: 15px 20px;
            flex-shrink: 0;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #374151; /* --- Dark border --- */
            background-color: #1f2937; /* --- Match sidebar --- */
            color: #f9fafb; /* --- Light text --- */
        }
        .search-input::placeholder {
            color: #6b7280; /* --- Darker gray placeholder --- */
        }
         .search-input:focus {
              outline: none;
              border-color: #4eca8b; /* Accent border on focus */
              box-shadow: 0 0 0 2px rgba(78, 202, 139, 0.3);
         }


        .add-module-btn {
            display: flex;
            align-items: center;
            justify-content: center; /* Center content */
            padding: 10px 20px;
            background-color: #4eca8b; /* --- Accent green --- */
            color: #ffffff; /* --- White text --- */
            cursor: pointer;
            margin: 15px 20px;
            border-radius: 4px;
            transition: background-color 0.2s;
            flex-shrink: 0;
            font-weight: 500;
        }

        .add-module-btn:hover {
            background-color: #3db97a; /* Darker green */
        }

        .add-module-btn i {
            margin-right: 8px;
            font-weight: bold;
            font-style: normal;
        }

        /* Module List Styles (Sidebar) */
        .modules-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px 10px 10px; /* Adjust padding */
        }

        .modules-list-container::-webkit-scrollbar { width: 6px; background-color: transparent; }
        .modules-list-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; } /* Darker thumb */
        .modules-list-container::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

        .module-item {
            padding: 8px 10px 8px 20px;
            cursor: pointer; display: flex; align-items: center; position: relative;
            transition: background-color 0.2s; white-space: nowrap; text-overflow: ellipsis;
            border-radius: 4px; /* Slightly more rounded */
            margin: 1px 0; /* Tighter spacing */
            color: #d1d5db; /* Light gray text */
        }
        .module-item:hover {
            background-color: #374151; /* Darker gray hover */
            color: #ffffff; /* White text on hover */
        }

        .module-item[data-level="1"] { padding-left: 30px; } /* Adjust indentation */
        .module-item[data-level="2"] { padding-left: 45px; }
        .module-item[data-level="3"] { padding-left: 60px; }

        .collapse-icon {
            display: inline-block; width: 16px; margin-right: 8px; /* More space */
            text-align: center; transition: transform 0.2s ease-in-out;
            color: #9ca3af; flex-shrink: 0;
        }
        .module-item.collapsed .collapse-icon { transform: rotate(-90deg); }
        .module-item:hover .collapse-icon { color: #fff; }

        .module-item[data-module-type="header"] {
             /* Headers could have slightly different style */
             margin-top: 8px;
        }
        .module-item[data-module-type="header"] .module-name {
            font-weight: 600;
            color: #a7f3d0; /* Lighter accent green for headers */
            text-transform: uppercase;
            font-size: 0.9em;
        }
         .module-item[data-module-type="header"]:hover .module-name {
              color: #ffffff;
         }


        .module-item.dragging { opacity: 0.6; background-color: #4b5563; border: 1px dashed #6b7280; }
        .module-item.drag-over-top { border-top: 2px solid #4eca8b; }
        .module-item.drag-over-bottom { border-bottom: 2px solid #4eca8b; }
        .module-item.drag-over-middle { background-color: #4b5563; outline: 2px dashed #4eca8b; outline-offset: -2px; }

        .module-icon {
            margin-right: 8px; font-size: 1em; /* Larger icon placeholder */ cursor: pointer;
            width: 18px; text-align: center; position: relative; display: inline-block;
            flex-shrink: 0; color: #9ca3af; line-height: 1; /* Align dots better */
        }
         .module-icon:hover { color: #fff; }

        .module-drag-handle {
            cursor: move; position: absolute; left: 8px; /* Adjust position */ top: 50%;
            transform: translateY(-50%); opacity: 0; transition: opacity 0.2s;
            padding: 0 5px; flex-shrink: 0; color: #9ca3af;
        }
        .module-item:hover .module-drag-handle { opacity: 0.7; }
        .module-drag-handle:hover { opacity: 1; color: #fff; }

        .module-name {
            flex-grow: 1; overflow: hidden; text-overflow: ellipsis;
            margin-left: 5px;
        }

        .dropdown-menu {
            display: none; position: absolute;
            background-color: #374151; /* Dark background */
            min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.4); /* Darker shadow */
            z-index: 10; border-radius: 4px; left: 0; top: 100%;
            border: 1px solid #4b5563; /* Border */
        }
        .dropdown-item {
            padding: 8px 12px; /* Adjust padding */ text-decoration: none; display: block;
            font-size: 14px; white-space: nowrap;
            color: #d1d5db; /* Light text */ cursor: pointer;
             transition: background-color 0.2s, color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #4b5563; /* Slightly lighter dark */
            color: #ffffff; /* White text */
        }

        .module-item[data-requires-client="false"] .module-name::after {
            content: " ⚙️"; font-size: 14px; opacity: 0.7;
            display: inline-block; margin-left: 5px;
        }


        /* Main Content Area Styles */
        .main-content {
            width: 75%; height: 100%; overflow: hidden;
            background-color: #111827; /* --- Dark background --- */
            color: #d1d5db; /* --- Default light text --- */
            position: relative; display: flex; flex-direction: column;
        }
        .dashboard-header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #374151; /* Darker border */
            background-color: #1f2937; /* Match sidebar */
            color: #f9fafb; /* White text */
            flex-shrink: 0;
        }
        .dashboard-title { font-size: 1.5em; font-weight: 600; display: flex; align-items: center; }
        .dashboard-title i { margin-right: 10px; font-style: normal; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-small {
            padding: 5px 10px; font-size: 0.9em;
            background-color: #4b5563; /* Darker Gray */
            color: #e5e7eb; /* Lighter text */
             border: 1px solid #6b7280;
        }
        .btn-small:hover { background-color: #6b7280; } /* Hover */

        .total-cost { font-size: 1.2em; color: #34d399; font-weight: 600; } /* Tailwind emerald-400 */

        .dashboard-description {
            padding: 10px 20px; color: #9ca3af; /* Lighter gray text */
            background-color: #1f2937; /* Match header */ flex-shrink: 0;
            min-height: 38px; border-bottom: 1px solid #374151;
        }
        .dashboard-content { /* Main scrolling area */
            padding: 20px;
            background-color: #111827; /* --- Dark background --- */
            margin: 0; color: #d1d5db; /* Light text */
            flex: 1; overflow-y: auto; overflow-x: hidden;
        }
        .dashboard-content::-webkit-scrollbar { width: 8px; background-color: #1f2937; } /* Dark track */
        .dashboard-content::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; } /* Darker thumb */
        .dashboard-content::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

        /* --- DARK THEME TILE STYLES --- */
        .module-tile {
            background-color: #1f2937; /* --- Dark Tile Background (e.g., gray-800) --- */
            padding: 20px; /* More padding */
            border-radius: 6px; /* Slightly more rounded */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.3); /* Adjusted shadow for dark */
            position: relative; display: flex; flex-direction: column;
            justify-content: space-between; min-height: 160px; /* Increased height */
            transition: all 0.2s ease-in-out;
            border: 1px solid #374151; /* --- Dark Border (e.g., gray-700) --- */
            color: #d1d5db; /* Default light text for tile */
        }
         .module-tile:hover {
              transform: translateY(-3px);
              box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 4px 6px rgba(0,0,0,0.2); /* Enhanced shadow */
              border-color: #4b5563; /* Slightly lighter border on hover */
         }

        .module-tile h5 { /* Tile title */
            margin-bottom: 10px; font-size: 1.0em; /* Slightly smaller title */
            color: #f9fafb; /* --- White Title --- */
            font-weight: 500; /* Medium weight */
            text-transform: uppercase; /* Uppercase title */
            letter-spacing: 0.5px; /* Spacing */
            flex-grow: 1;
        }
        .module-tile-cost { /* Cost display */
            font-size: 1.6em; /* Larger cost */
            margin: 10px 0;
            color: #ffffff; /* --- White Cost --- */
            font-weight: 600;
        }
         .module-tile-cost small { /* Annotation */
              font-size: 0.6em; font-weight: normal;
              opacity: 0.8;
              color: #9ca3af; /* --- Medium Gray annotation --- */
              display: block; /* Put annotation on new line */
              margin-top: -5px; /* Adjust spacing */
         }

        .clear-module-btn { /* Clear button 'X' */
            position: absolute; top: 10px; right: 10px; /* Adjust position */
            background: none; border: none;
            color: #9ca3af; /* --- Medium Gray icon --- */
            cursor: pointer; font-size: 18px; border-radius: 50%;
            width: 28px; height: 28px; line-height: 28px; /* Slightly larger */
            text-align: center; padding: 0; opacity: 0.6;
            transition: all 0.2s;
        }
        .module-tile:hover .clear-module-btn { opacity: 1; }
        .clear-module-btn:hover {
            background-color: #374151; /* Dark gray background */
            color: #ef4444; /* Red color */
        }

        /* General Button Styles (Adjusted for Dark Theme) */
        .btn {
            background-color: #3b82f6; /* --- ACCENT BLUE --- */
            color: white;
            border: none; padding: 8px 16px; border-radius: 4px;
            cursor: pointer; transition: background-color 0.2s;
            text-align: center; font-weight: 500;
        }
        .btn:hover:not(:disabled) {
            background-color: #2563eb; /* Darker Blue */
        }
         .btn:disabled { /* Disabled button style for dark theme */
              background-color: #374151; /* --- Dark Gray Background --- */
              color: #6b7280; /* --- Darker Gray text --- */
              cursor: not-allowed;
              opacity: 0.7;
         }

        .btn-cancel {
            background-color: #4b5563; /* Darker Gray */
            color: #d1d5db; /* Light Gray text */
             border: 1px solid #6b7280;
        }
        .btn-cancel:hover {
            background-color: #6b7280;
             color: #f9fafb;
        }

        /* Modal Styles (Keep light for contrast, or make dark too?) */
        /* Keeping modals light for now */
        .modal-overlay { /* Unchanged */ }
        .modal { /* Unchanged */ }
        .modal-header { /* Unchanged */ }
        .modal-title { /* Unchanged */ }
        .modal-close { /* Unchanged */ }
        .modal-close:hover { /* Unchanged */ }
        .modal-body { /* Unchanged */ }
        .form-group { /* Unchanged */ }
        .form-group label { /* Unchanged */ }
        .form-control { /* Unchanged */ }
        .form-control:focus { /* Unchanged */ }
        .modal-footer { /* Unchanged */ }

        /* Client List in Modal */
        .client-list { /* Unchanged */ }
        .client-list-item { /* Unchanged */ }
        .client-list-item:last-child { /* Unchanged */ }
        .client-list-item:hover { /* Unchanged */ }
        .client-list-item.active { /* Unchanged */ }

        /* Add Module Modal Specific Styles */
        #add-module-modal .modal-body { /* Unchanged */ }
        #add-module-modal select, #add-module-modal input[type="text"] { /* Unchanged */ }
        #add-module-modal input[type="checkbox"] { /* Unchanged */ }
        #add-module-modal label small { /* Unchanged */ }

        /* Debug Panel (Keep as is) */
        .debug-panel { /* Unchanged */ }
        #debug-toggle-btn { /* Unchanged */ }
        #debug-toggle-btn:hover { /* Unchanged */ }

        /* --- Grid container and No Data tile styles --- */
        .dashboard-content #module-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px; /* Increased gap */
            padding-top: 10px;
        }

        .module-tile.no-client-data {
            opacity: 0.85;
            background-color: #1f2937; /* Match active tile background */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Less shadow */
            border-color: #374151; /* Match active tile border */
        }
        .module-tile.no-client-data h5 {
             color: #9ca3af; /* Dim title */
        }
        .module-tile.no-client-data .module-tile-cost {
            color: #6b7280; /* Dim cost */
        }
         .module-tile.no-client-data .module-tile-cost small {
              color: #6b7280;
         }

        /* Notification Style for Dark Theme */
        .no-client-notification {
            padding: 30px;
            background-color: #1f2937; /* Match tile background */
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #374151; /* Match tile border */
        }
        .no-client-notification h2 {
            color: #e5e7eb; /* Lighter text */
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        .no-client-notification p {
            font-size: 1.1em;
            margin-bottom: 0;
            color: #9ca3af; /* Lighter gray text */
        }

        /* --- END DARK THEME UPDATE --- */

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Construction Estimator</div>

        <div class="section-title">Clients</div>
        <div class="client-actions">
            <div class="client-action" id="new-client-btn" title="Create a new client project"><i>+</i> New Client</div>
            <div class="client-action" id="open-client-btn" title="Open an existing client project"><i>O</i> Open Client</div>
        </div>

        <div class="search-container">
            <input type="text" id="module-search-input" class="search-input" placeholder="Search modules...">
        </div>

        <div class="add-module-btn" id="add-module-btn" title="Add a new module or category header"><i>+</i> Add New Module</div>

        <div class="modules-list-container" id="modules-container">
            </div>
    </div>

    <div class="main-content">
        <div class="dashboard-header">
            <div class="dashboard-title"><i>D</i> Dashboard</div>
            <div id="client-name-display" style="margin-left: 20px; font-weight: bold;"></div>
            <div class="header-actions">
                 <button id="logout-btn" class="btn btn-small" style="display: none;" title="Close the current client project">Logout Client</button>
                 <div class="total-cost" id="total-project-cost">Total Project Cost: R0.00</div>
            </div>
        </div>

        <div class="dashboard-description" id="dashboard-description">Overview of project data.</div>

        <div class="dashboard-content">
            <div id="module-content">
                <div style="padding: 20px; background-color: #1f2937; color: #d1d5db; border-radius: 5px; margin-bottom: 20px;">
                    <h3>Loading Dashboard...</h3>
                    <p>Please wait while the application initializes.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-panel" id="debug-panel"></div>
    <button id="debug-toggle-btn" style="display: none;">Debug</button>


    <div class="modal-overlay" id="client-modal-overlay"></div>

    <div class="modal-overlay" id="add-module-modal-overlay">
        <div class="modal" id="add-module-modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Module / Category</h2>
                <span class="modal-close" data-modal-id="add-module-modal-overlay">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-module-name">Module Name:</label>
                    <input type="text" id="new-module-name" class="form-control" required placeholder="e.g., Roofing, Finishes, Site Prep">
                </div>
                <div class="form-group">
                    <label for="new-module-type">Type:</label>
                    <select id="new-module-type" class="form-control">
                        <option value="regular" selected>Regular Module (e.g., Concrete, Brickwork)</option>
                        <option value="header">Header / Category (e.g., Foundations, Structure)</option>
                    </select>
                </div>
                <div class="form-group" id="parent-header-group">
                    <label for="parent-header-select">Place Under Header:</label>
                    <select id="parent-header-select" class="form-control">
                        <option value="null">(Top Level / No Parent)</option>
                        </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="new-module-requires-client" checked> Requires Client Selection
                        <small>Check if module involves client-specific estimates. Uncheck for general setup/config modules.</small>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" data-modal-id="add-module-modal-overlay">Cancel</button>
                <button class="btn btn-save" id="save-new-module-btn">Add Module</button>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js" defer></script>

</body>
</html>
