<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        .sidebar {
            width: 25%;
            background-color: #1c2639;
            color: #fff;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid #333;
        }

        .main-content {
            width: 75%;
            height: 100%;
            overflow: hidden;
            background-color: white;
            color: #333;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.4em;
            font-weight: bold;
            border-bottom: 1px solid #333;
        }

        .section-title {
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .client-actions {
            padding: 0 20px;
        }

        .client-action {
            display: flex;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
        }

        .client-action i {
            margin-right: 10px;
        }

        .client-action:hover {
            color: #4eca8b;
        }

        /* Client Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 500px;
            max-width: 90%;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5em;
            color: #888;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .btn-cancel {
            background-color: #ddd;
            color: #333;
            margin-right: 10px;
        }

        .client-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .client-list-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .client-list-item:last-child {
            border-bottom: none;
        }

        .client-list-item:hover {
            background-color: #f5f5f5;
        }

        .client-list-item.active {
            background-color: #e9e9e9;
        }

        .search-container {
            padding: 20px;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background-color: #2d364a;
            color: #fff;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .modules-list {
            padding: 10px 0;
        }

        .module-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            position: relative;
            transition: background-color 0.2s;
        }

        .module-item:hover {
            background-color: #2d364a;
        }

        .module-item.dragging {
            opacity: 0.5;
            background-color: #3a4967;
            border: 1px dashed #aaa;
        }

        .module-item.drag-over {
            border-top: 2px solid #4eca8b;
        }

        .module-icon {
            margin-right: 10px;
            font-size: 0.8em;
            cursor: pointer;
            width: 20px;
            text-align: center;
            position: relative;
            display: inline-block;
        }

        .module-drag-handle {
            cursor: move;
            position: absolute;
            left: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-item:hover .module-drag-handle {
            opacity: 0.7;
        }

        /* Dropdown styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            left: 0;
            top: 100%;
            color: #333;
        }

        .module-icon:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 10px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        .dashboard-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            background-color: #1c2639;
            color: #fff;
        }

        .dashboard-title {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .dashboard-title i {
            margin-right: 10px;
        }

        .total-cost {
            font-size: 1.2em;
            color: #4eca8b;
        }

        .dashboard-description {
            padding: 10px 20px;
            color: #aaa;
            background-color: #1c2639;
        }

        .dashboard-content {
            padding: 20px;
            background-color: #fff;
            margin: 0;
            color: #333;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom scrollbar styling */
        .dashboard-content::-webkit-scrollbar {
            width: 8px;
            background-color: #f5f5f5;
        }

        .dashboard-content::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 4px;
        }

        .dashboard-content::-webkit-scrollbar-thumb:hover {
            background-color: #888;
        }

        .dashboard-content-header {
            margin-bottom: 20px;
        }

        .dashboard-content-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .dashboard-content-description {
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        input[type="number"] {
            width: 100%;
            padding: 5px;
        }

        .total-row {
            font-weight: bold;
            background-color: #e9e9e9;
        }

        .btn {
            background-color: #4eca8b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #3db97a;
        }

        .scroll-container {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom scrollbar styling for sidebar */
        .scroll-container::-webkit-scrollbar {
            width: 6px;
            background-color: transparent;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">Construction Estimator</div>

        <div class="section-title">Clients</div>
        <div class="client-actions">
            <div class="client-action" id="new-client-btn">
                <i>+</i> New Client
            </div>
            <div class="client-action" id="open-client-btn">
                <i>O</i> Open Client
            </div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search modules...">
        </div>

        <div class="scroll-container">
            <div class="modules-list" id="modules-container">
                <div class="module-item" draggable="true" data-module-id="notes">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Notes</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="p-and-gs">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>P & Gs</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="demolish">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Demolish & Strip</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="toolhire">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Toolhire</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="earthworks">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Earthworks</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="foundations">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Foundations</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="brickwork">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Brickwork & Cavity Fill</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="surfacebeds">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Surfacebeds</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="plaster">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Plaster</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="concrete">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Concrete Slab & Stairs</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="steel">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Specialized Steel</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="roofing">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Roofing</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="windows">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Alu Windows and Doors</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="ceilings">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Ceilings</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="flooring">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Floor and Wall Covering</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="carpentry">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Carpentry and Joinery</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="painting">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Painting</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="plumbing">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Plumbing</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="electrical">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Electrical</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="waterproofing">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Waterproofing</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="fireplaces">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Fireplace's & Braai's</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="external">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>External Works</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="fees">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Fee's</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="admin">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Admin</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="renovation">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Renovation Quote</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="quote">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Quote</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="data">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Data</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="price_list">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>Price List</span>
                </div>
                <div class="module-item" draggable="true" data-module-id="pc_items">
                    <div class="module-drag-handle">≡</div>
                    <div class="module-icon">
                        ...
                        <div class="dropdown-menu">
                            <div class="dropdown-item edit-module">Edit</div>
                            <div class="dropdown-item delete-module">Delete</div>
                        </div>
                    </div>
                    <span>PC Items</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <i>D</i> Dashboard
            </div>
            <div id="client-name-display" style="margin-left: 20px;"></div>
            <div class="total-cost">
                Total Project Cost: $0
            </div>
        </div>

        <div class="dashboard-description">
            Overview of project data.
        </div>

        <div class="dashboard-content">
            <div class="dashboard-content-header">
                <div class="dashboard-content-title">Project Dashboard</div>
                <div class="dashboard-content-description">Welcome to the dashboard! Here's where key project information will be displayed.</div>
            </div>

            <div id="module-content">
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "qh-dashboard-d67cf.firebaseapp.com",
            projectId: "qh-dashboard-d67cf",
            storageBucket: "qh-dashboard-d67cf.firebasestorage.app",
            messagingSenderId: "939838453148",
            appId: "1:939838453148:web:2bf49c6ec240343b934459"
        };

        // Initialize Firebase - FIXED: Proper initialization sequence
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Fallback for demo/testing - create an in-memory database substitute
            db = {
                collection: function(name) {
                    return {
                        doc: function(id) {
                            return {
                                set: function(data, options) {
                                    console.log(`Mock DB: saving ${name} document ${id}:`, data, options);
                                    return Promise.resolve();
                                },
                                get: function() {
                                    return Promise.resolve({
                                        exists: false,
                                        data: function() { return null; }
                                    });
                                },
                                update: function(data) {
                                    console.log(`Mock DB: updating ${name} document ${id}:`, data);
                                    return Promise.resolve();
                                },
                                delete: function(){
                                    console.log(`Mock delete ${name}/${id}`);
                                    return Promise.resolve();
                                }
                            };
                        },
                        get: function(){
                            return Promise.resolve({
                                empty: true,
                                forEach: function(){}
                            });
                        }
                    };
                }
            };
            console.log("Using mock database for testing");
        }

        // Sample data structure for all modules
        const appData = {
            clients: [], // Array to hold client objects
            currentClient: null, // To hold the currently selected client
            modules: [
                {
                    id: 'notes',
                    name: 'Notes',
                    renderTemplate: function(client) {
                        const notesData = client?.moduleData?.notes?.notes || '';
                        return `
                            <h3>Project Notes</h3>
                            <textarea id="project-notes" rows="10" style="width: 100%; padding: 10px;" placeholder="Enter project notes here...">${notesData}</textarea>
                            <button class="btn module-save-btn" data-module="notes" style="margin-top: 10px;">Save Notes</button>
                        `;
                    },
                    saveData: function() {
                        const notes = document.getElementById('project-notes').value;
                        return { notes: notes };
                    }
                },
                {
                    id: 'p-and-gs',
                    name: 'P & Gs',
                    renderTemplate: function(client) {
                        const pgsData = client?.moduleData?.['p-and-gs']?.items || [
                            { quantity: 1, rate: 1000 },
                            { quantity: 1, rate: 500 },
                            { quantity: 100, rate: 10 },
                        ];

                        let total = 0;
                        let tableRows = pgsData.map((item, index) => {
                            const amount = item.quantity * item.rate;
                            total += amount;
                            return `
                                <tr>
                                    <td>${index === 0 ? 'Management Staff' : index === 1 ? 'Site Office' : 'Temporary Fencing'}</td>
                                    <td><input type="number" class="p-gs-quantity" data-index="${index}" value="${item.quantity}"></td>
                                    <td>${item.rate}</td>
                                    <td>${amount}</td>
                                </tr>
                            `;
                        }).join('');

                        return `
                            <h3>Preliminaries and General Conditions</h3>
                            <p>Enter the quantities for each item. Rates are fixed.</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                    <tr class="total-row">
                                        <td colspan="3">Total</td>
                                        <td>${total}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn module-save-btn" data-module="p-and-gs">Save P&Gs</button>
                        `;
                    },
                    saveData: function() {
                        const quantities = Array.from(document.querySelectorAll('.p-gs-quantity')).map(input => parseFloat(input.value));
                        const rates = [1000, 500, 10]; // Fixed rates
                        const items = quantities.map((quantity, index) => ({
                            quantity: quantity,
                            rate: rates[index],
                        }));
                        return { items: items };
                    },
                },
                {
                    id: 'demolish',
                    name: 'Demolish & Strip',
                    renderTemplate: function(client) {
                        const demolishData = client?.moduleData?.demolish?.items || [
                            { quantity: 50, rate: 20 },
                            { quantity: 100, rate: 15 },
                        ];
                        let total = 0;
                        let tableRows = demolishData.map((item, index) => {
                            const amount = item.quantity * item.rate;
                            total += amount;
                            return `
                                <tr>
                                    <td>${index === 0 ? 'Demolish Walls' : 'Remove Floor Finishes'}</td>
                                    <td><input type="number" class="demolish-quantity" data-index="${index}" value="${item.quantity}"></td>
                                    <td>${item.rate}</td>
                                    <td>${amount}</td>
                                </tr>
                            `;
                        }).join('');

                        return `
                            <h3>Demolish and Strip</h3>
                            <p>Enter the quantities for demolition and strip items.</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                    <tr class="total-row">
                                        <td colspan="3">Total</td>
                                        <td>${total}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn module-save-btn" data-module="demolish">Save Demolition</button>
                        `;
                    },
                    saveData() {
                        const quantities = Array.from(document.querySelectorAll('.demolish-quantity')).map(input => parseFloat(input.value));
                        const rates = [20, 15];
                        const items = quantities.map((quantity, index) => ({
                            quantity,
                            rate: rates[index],
                        }));
                        return { items };
                    },
                },
                // Additional modules can be added here
            ],
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing app");
            initApp();
            setupDropdownMenus();
            setupClientManagement();
            loadClientsFromFirestore();
        });

        // Load clients from Firestore
        async function loadClientsFromFirestore() {
            try {
                console.log("Attempting to load clients from Firestore");
                const clientsSnapshot = await db.collection('clients').get();
                
                if (!clientsSnapshot.empty) {
                    clientsSnapshot.forEach(doc => {
                        const clientData = doc.data();
                        appData.clients.push(clientData);
                        console.log("Loaded client:", clientData.name);
                    });
                    console.log(`Loaded ${appData.clients.length} clients from Firestore`);
                } else {
                    console.log("No clients found in Firestore");
                }
            } catch (error) {
                console.error("Error loading clients from Firestore:", error);
            }
        }

        function initApp() {
            console.log("Initializing app");
            // Attach click event listeners to module items
            document.querySelectorAll('.module-item').forEach(item => {
                // Only attachthe event to the text part, not the icon
                const moduleText = item.querySelector('span');
                if (moduleText) {
                    moduleText.addEventListener('click', function() {
                        console.log("Module clicked:", this.textContent.trim());
                        // Get the module name
                        const moduleName = this.textContent.trim();

                        // Check if we have an active client
                        if (!appData.currentClient) {
                            // Show message that client needs to be selected first
                            document.getElementById('module-content').innerHTML = `
                                <div style="padding: 20px; background-color: #fff4e5; border-left: 4px solid #ffa940; margin-bottom: 20px;">
                                    <h3>Client Required</h3>
                                    <p>Please select or create a client before accessing modules.</p>
                                    <button class="btn" id="quick-new-client">Create New Client</button>
                                    <button class="btn" style="margin-left: 10px;" id="quick-open-client">Open Existing Client</button>
                                </div>
                            `;

                            // Add event listeners to the quick buttons
                            document.getElementById('quick-new-client').addEventListener('click', function() {
                                document.getElementById('new-client-btn').click();
                            });

                            document.getElementById('quick-open-client').addEventListener('click', function() {
                                document.getElementById('open-client-btn').click();
                            });

                            return;
                        }

                        // Find the module in the data
                        const module = appData.modules.find(mod => mod.name === moduleName);

                        if (module) {
                            // Render the module with the current client's data
                            document.getElementById('module-content').innerHTML = module.renderTemplate(appData.currentClient);

                            // Add event listeners for module interactions
                            setupModuleInteractions(module.id);
                        } else {
                            // If module not found in data, show placeholder
                            document.getElementById('module-content').innerHTML = `
                                <h3>${moduleName}</h3>
                                <p>This module is currently under development.</p>
                            `;
                        }

                        // Add active class to selected module
                        document.querySelectorAll('.module-item').forEach(m => m.classList.remove('active'));
                        item.classList.add('active');
                    });
                }
            });

            // Set up drag and drop functionality
            setupDragAndDrop();
        }

        // Set up module-specific interactions
        function setupModuleInteractions(moduleId) {
            console.log("Setting up interactions for module:", moduleId);
            // Add event listeners for the save buttons in the module
            const saveButtons = document.querySelectorAll('.module-save-btn');
            saveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const moduleId = this.getAttribute('data-module');
                    console.log("Save button clicked for module:", moduleId);
                    saveModuleData(moduleId);
                });
            });

            // Add specific handling for each module type
            if (moduleId === 'notes') {
                // No special setup needed for notes
            } else if (moduleId === 'p-and-gs') {
                // Add event listeners for quantity changes
                document.querySelectorAll('.p-gs-quantity').forEach(input => {
                    input.addEventListener('change', function() {
                        updatePGsCalculations();
                    });
                });
                updatePGsCalculations();
            } else if (moduleId === 'demolish') {
                document.querySelectorAll('.demolish-quantity').forEach(input => {
                    input.addEventListener('change', function() {
                        updateDemolishCalculations();
                    });
                });
                updateDemolishCalculations();
            }
            // Add more module-specific setup as needed
        }

        // Save module data to the current client
        function saveModuleData(moduleId) {
            if (!appData.currentClient) {
                console.error("No active client to save data to");
                return;
            }

            console.log("Saving data for module:", moduleId);

            // Initialize moduleData if it doesn't exist
            if (!appData.currentClient.moduleData) {
                appData.currentClient.moduleData = {};
            }

            // Save data based on module type
            const module = appData.modules.find(m => m.id === moduleId);
            if (module) {
                const data = module.saveData();
                appData.currentClient.moduleData[moduleId] = data;
                saveModuleDataToFirestore(appData.currentClient.id, moduleId, data);
                console.log("Module data saved:", data);
            }

            // Recalculate total project cost after saving any module
            updateTotalProjectCost();
        }
        
        async function saveModuleDataToFirestore(clientId, moduleId, data) {
            try {
                console.log(`Saving ${moduleId} data to Firestore for client ${clientId}`);
                const clientRef = db.collection('clients').doc(clientId);
                await clientRef.set({
                    moduleData: {
                        [moduleId]: data
                    }
                }, { merge: true });
                console.log(`${moduleId} data saved to Firestore for client ${clientId}`);
            } catch (error) {
                console.error(`Error saving ${moduleId} data to Firestore:`, error);
            }
        }

        // Update P&Gs calculations based on current input values
        function updatePGsCalculations() {
            if (!appData.currentClient) return;

            // Get current module data
            const moduleData = appData.currentClient.moduleData?.['p-and-gs'] || { items: [] };
            const items = moduleData.items?.length ? [...moduleData.items] : [
                { quantity: 1, rate: 1000 },
                { quantity: 1, rate: 500 },
                { quantity: 100, rate: 10 }
            ];

            // Update quantities from input fields
            document.querySelectorAll('.p-gs-quantity').forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const newQuantity = parseFloat(input.value);

                if (items[index] && !isNaN(newQuantity)) {
                    items[index].quantity = newQuantity;
                }
            });

            // Calculate amounts and total
            let total = 0;
            const rows = document.querySelectorAll('table tbody tr:not(.total-row)');

            items.forEach((item, index) => {
                if (index < rows.length) {
                    const amount = item.quantity * item.rate;
                    total += amount;

                    // Update the amount cell
                    const amountCell = rows[index].querySelector('td:last-child');
                    if (amountCell) {
                        amountCell.textContent = amount;
                    }
                }
            });

            // Update the total row
            const totalCell = document.querySelector('table .total-row td:last-child');
            if (totalCell) {
                totalCell.textContent = total;
            }
        }

        function updateDemolishCalculations() {
            if (!appData.currentClient) return;

            const moduleData = appData.currentClient.moduleData?.['demolish'] || { items: [] };
            const items = moduleData.items?.length ? [...moduleData.items] : [
                { quantity: 50, rate: 20 },
                { quantity: 100, rate: 15 }
            ];

            document.querySelectorAll('.demolish-quantity').forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const newQuantity = parseFloat(input.value);

                if (items[index] && !isNaN(newQuantity)) {
                    items[index].quantity = newQuantity;
                }
            });

            let total = 0;
            const rows = document.querySelectorAll('table tbody tr:not(.total-row)');

            items.forEach((item, index) => {
                if (index < rows.length) {
                    const amount = item.quantity * item.rate;
                    total += amount;

                    const amountCell = rows[index].querySelector('td:last-child');
                    if (amountCell) {
                        amountCell.textContent = amount;
                    }
                }
            });

            const totalCell = document.querySelector('table .total-row td:last-child');
            if (totalCell) {
                totalCell.textContent = total;
            }
        }

        function setupDragAndDrop() {
            const moduleItems = document.querySelectorAll('.module-item');
            let draggedItem = null;

            moduleItems.forEach(item => {
                // Drag start event
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => this.classList.add('dragging'), 0);

                    // Store data about the dragged item
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-module-id'));
                    e.dataTransfer.effectAllowed = 'move';
                });

                // Drag end event
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    moduleItems.forEach(item => item.classList.remove('drag-over'));
                });

                // Drag over event
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (this !== draggedItem) {
                        this.classList.add('drag-over');
                    }
                });

                // Drag leave event
                item.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });

                // Drop event
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');

                    if (this !== draggedItem) {
                        const modulesContainer = document.getElementById('modules-container');
                        const allItems = Array.from(modulesContainer.querySelectorAll('.module-item'));
                        const draggedIndex = allItems.indexOf(draggedItem);
                        const targetIndex = allItems.indexOf(this);

                        // If dropping after the target, insert after, otherwise insert before
                        if (draggedIndex < targetIndex) {
                            this.parentNode.insertBefore(draggedItem, this.nextSibling);
                        } else {
                            this.parentNode.insertBefore(draggedItem, this);
                        }

                        // Update the data array order if needed
                        updateModuleOrder();
                    }
                });

                // Add click handler for the drag handle
                const dragHandle = item.querySelector('.module-drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('mousedown', function(e) {
                        // Prevent the dropdown from opening when drag starts
                        e.stopPropagation();
                    });
                }
            });
        }

        function updateModuleOrder() {
            // This function could be implemented to update the underlying data structure
            // based on the new order of modules in the DOM
            const moduleItems = document.querySelectorAll('.module-item');
            const newOrder = Array.from(moduleItems).map(item => item.querySelector('span').textContent.trim());

            // For now, just log the new order
            console.log('New module order:', newOrder);

            // In a full implementation, you would rearrange your data array to match this order
        }

        function setupDropdownMenus() {
            console.log("Setting up dropdown menus");
            // Stop propagation for dropdown to prevent module selection
            document.querySelectorAll('.module-icon').forEach(icon => {
                icon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Toggle the dropdown
                    const dropdown = this.querySelector('.dropdown-menu');
                    if (dropdown) {
                        // Close other open dropdowns
                        document.querySelectorAll('.dropdown-menu').forEach(menu => {
                            if (menu !== dropdown && menu.style.display === 'block') {
                                menu.style.display = 'none';
                            }
                        });

                        // Toggle this dropdown
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });

            // Add click event for edit option
            document.querySelectorAll('.edit-module').forEach(editBtn => {
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const moduleItem = this.closest('.module-item');
                    const moduleName = moduleItem.querySelector('span').textContent.trim();
                    editModule(moduleName, moduleItem);
                });
            });

            // Add click event for delete option
            document.querySelectorAll('.delete-module').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const moduleItem = this.closest('.module-item');
                    const moduleName = moduleItem.querySelector('span').textContent.trim();
                    deleteModule(moduleName, moduleItem);
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            });
        }

        function editModule(moduleName, moduleElement) {
            // Create a simple edit prompt
            const newName = prompt(`Edit module name:`, moduleName);

            if (newName && newName.trim() !== '' && newName !== moduleName) {
                // Update the module name
                moduleElement.querySelector('span').textContent = newName;

                // Find and update the module in data if it exists
                const moduleIndex = appData.modules.findIndex(mod => mod.name === moduleName);
                if (moduleIndex !== -1) {
                    appData.modules[moduleIndex].name = newName;
                }

                // Show success message
                alert(`Module renamed to "${newName}"`);
            }
        }

        function deleteModule(moduleName, moduleElement) {
            // Confirm before deleting
            if (confirm(`Are you sure you want to delete the "${moduleName}" module?`)) {
                // Remove the module element from DOM
                moduleElement.remove();

                // Remove from data array if it exists
                const moduleIndex = appData.modules.findIndex(mod => mod.name === moduleName);
                if (moduleIndex !== -1) {
                    appData.modules.splice(moduleIndex, 1);
                }

                // Show success message
                alert(`Module "${moduleName}" has been deleted`);
            }
        }

        function setupClientManagement() {
            console.log("Setting up client management");
            const newClientBtn = document.getElementById('new-client-btn');
            const openClientBtn = document.getElementById('open-client-btn');
            
            // Create modal overlay if it doesn't exist
            let modalOverlay = document.querySelector('.modal-overlay');
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
            }

            // New client button event listener
            newClientBtn.addEventListener('click', () => {
                console.log("New Client button clicked");
                const clientModal = createClientModal('new');
                console.log("New client modal created");
                
                // Clear any existing content
                modalOverlay.innerHTML = '';
                modalOverlay.appendChild(clientModal);
                modalOverlay.style.display = 'flex';
            });

            // Open client button event listener
            openClientBtn.addEventListener('click', () => {
                console.log("Open Client button clicked");
                const clientModal = createClientModal('open');
                console.log("Open client modal created");
                
                // Clear any existing content
                modalOverlay.innerHTML = '';
                modalOverlay.appendChild(clientModal);
                modalOverlay.style.display = 'flex';
            });

            // Close modal when clicking outside
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            });
        }

        function createClientModal(type) {
            console.log(`Creating ${type} client modal`);
            const modal = document.createElement('div');
            modal.className = 'modal';

            if (type === 'new') {
                modal.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">New Client</h2>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="client-name">Client Name:</label>
                            <input type="text" id="client-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="client-address">Client Address:</label>
                            <input type="text" id="client-address" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel">Cancel</button>
                        <button class="btn btn-save">Save</button>
                    </div>
                `;

                // Set up event handlers after the modal is fully created
                setTimeout(() => {
                    const closeBtn = modal.querySelector('.modal-close');
                    closeBtn.addEventListener('click', () => {
                        modal.closest('.modal-overlay').style.display = 'none';
                    });

                    const cancelBtn = modal.querySelector('.btn-cancel');
                    cancelBtn.addEventListener('click', () => {
                        modal.closest('.modal-overlay').style.display = 'none';
                    });

                    const saveBtn = modal.querySelector('.btn-save');
                    console.log("Save button in new client modal:", saveBtn);
                    
                    saveBtn.addEventListener('click', () => {
                        console.log("Save button clicked");
                        const name = document.getElementById('client-name').value;
                        const address = document.getElementById('client-address').value;

                        if (name.trim() === '') {
                            alert('Client name is required');
                            return;
                        }

                        const newClient = {
                            name: name,
                            address: address,
                            id: `client-${Date.now()}`, // Simple unique ID
                            moduleData: {}
                        };

                        appData.clients.push(newClient);
                        appData.currentClient = newClient;

                        // Save to Firestore
                        saveClientToFirestore(newClient);

                        alert(`Client "${name}" created and selected.`);
                        modal.closest('.modal-overlay').style.display = 'none';

                        // Update dashboard to show client info
                        updateDashboard(newClient);
                    });
                }, 0);
            } else if (type === 'open') {
                let clientListHTML = '';
                if (appData.clients.length > 0) {
                    clientListHTML = appData.clients.map((client, index) => 
                        `<div class="client-list-item" data-client-index="${index}">${client.name}</div>`
                    ).join('');
                } else {
                    clientListHTML = '<div class="client-list-item">No clients found</div>';
                }

                modal.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">Open Client</h2>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="client-search">Search Clients:</label>
                            <input type="text" id="client-search" class="form-control">
                        </div>
                        <div class="client-list">
                            ${clientListHTML}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel">Cancel</button>
                    </div>
                `;

                // Set up event handlers
                setTimeout(() => {
                    const closeBtn = modal.querySelector('.modal-close');
                    closeBtn.addEventListener('click', () => {
                        modal.closest('.modal-overlay').style.display = 'none';
                    });

                    const cancelBtn = modal.querySelector('.btn-cancel');
                    cancelBtn.addEventListener('click', () => {
                        modal.closest('.modal-overlay').style.display = 'none';
                    });

                    // Set up client selection
                    setupClientListSelection(modal);

                    // Set up search filtering
                    const searchInput = modal.querySelector('#client-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', () => {
                            const searchTerm = searchInput.value.toLowerCase();
                            const clientItems = modal.querySelectorAll('.client-list-item');
                            
                            clientItems.forEach(item => {
                                const clientName = item.textContent.toLowerCase();
                                if (clientName.includes(searchTerm)) {
                                    item.style.display = 'block';
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                        });
                    }
                }, 0);
            }

            return modal;
        }

        async function saveClientToFirestore(client) {
            try {
                console.log("Attempting to save client:", client);
                const clientRef = db.collection('clients').doc(client.id);
                await clientRef.set(client);
                console.log("Client data saved to Firestore:", client);
            } catch (error) {
                console.error("Error saving client data to Firestore:", error);
                // Continue even if Firestore fails - we're using in-memory storage as backup
            }
        }

        function setupClientListSelection(modal) {
            console.log("Setting up client list selection");
            const clientListItems = modal.querySelectorAll('.client-list-item');
            
            clientListItems.forEach(item => {
                // Skip the "No clients found" message
                if (item.getAttribute('data-client-index') === null) {
                    return;
                }
                
                item.addEventListener('click', () => {
                    const clientIndex = item.getAttribute('data-client-index');
                    console.log("Client selected at index:", clientIndex);
                    
                    if (clientIndex !== null && appData.clients[clientIndex]) {
                        appData.currentClient = appData.clients[clientIndex];
                        
                        // Update dashboard
                        updateDashboard(appData.clients[clientIndex]);
                        
                        modal.closest('.modal-overlay').style.display = 'none';
                        alert(`Client "${appData.currentClient.name}" selected.`);
                    }
                });
            });
        }

        function updateDashboard(client) {
            console.log("Updating dashboard for client:", client?.name);
            
            const dashboardHeader = document.querySelector('.dashboard-header');
            const dashboardDescription = document.querySelector('.dashboard-description');

            if (client) {
                // Update total cost
                const totalCost = calculateTotalProjectCost();
                
                dashboardHeader.innerHTML = `
                    <div class="dashboard-title">
                        <i>D</i> Dashboard
                    </div>
                    <div id="client-name-display" style="margin-left: 20px;">Client: ${client.name}</div>
                    <div class="total-cost">
                        Total Project Cost: $${totalCost}
                    </div>
                `;
                
                dashboardDescription.textContent = `Client: ${client.name}, Address: ${client.address || 'Not specified'}`;
                
                // If a module is open, re-render it for the selected client
                const activeModule = document.querySelector('.module-item.active');
                if (activeModule) {
                    const moduleName = activeModule.querySelector('span').textContent.trim();
                    const module = appData.modules.find(m => m.id === moduleName);
                    if (module) {
                        document.getElementById('module-content').innerHTML = module.renderTemplate(client);
                        setupModuleInteractions(module.id);
                    }
                }
            } else {
                dashboardHeader.innerHTML = `
                    <div class="dashboard-title">
                        <i>D</i> Dashboard
                    </div>
                    <div class="total-cost">
                        Total Project Cost: $0
                    </div>
                `;
                dashboardDescription.textContent = 'Please select a client to view project data.';
                document.getElementById('module-content').innerHTML = ''; // Clear module content
            }
        }

        function updateTotalProjectCost() {
            const totalCost = calculateTotalProjectCost();
            const totalCostElement = document.querySelector('.total-cost');
            if (totalCostElement) {
                totalCostElement.textContent = `Total Project Cost: $${totalCost}`;
            }
        }

        function calculateTotalProjectCost() {
            let totalCost = 0;
            
            if (appData.currentClient && appData.currentClient.moduleData) {
                for (const moduleId in appData.currentClient.moduleData) {
                    const moduleData = appData.currentClient.moduleData[moduleId];
                    
                    if (moduleId === 'p-and-gs' || moduleId === 'demolish') {
                        if (moduleData && moduleData.items) {
                            moduleData.items.forEach(item => {
                                totalCost += item.quantity * item.rate;
                            });
                        }
                    }
                    // Add other module type calculations as needed
                }
            }
            
            return totalCost;
        }
    </script>
</body>
</html>
