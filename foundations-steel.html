<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Foundations Steel - Construction Estimator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/client-manager.js"></script>
    <script src="js/module-utils.js"></script>
    <script src="js/data-models.js"></script>

    <style>
        /* Basic reset and font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        /* Flex layout for the main body */
        body {
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
            background-color: #f5f5f5;
        }

        /* Sidebar styling */
        .sidebar {
            width: 25%;
            background-color: #1c2639; /* Dark blue */
            color: #fff;
            height: 100%;
            overflow-y: auto; /* Scroll only if needed */
            border-right: 1px solid #333; /* Separator */
        }

        /* Main content area styling */
        .main-content {
            width: 75%;
            height: 100%;
            overflow: hidden; /* Prevent overflow */
            background-color: white;
            color: #333;
            position: relative; /* For potential absolute positioning inside */
            display: flex;
            flex-direction: column; /* Stack header, description, content */
        }

        /* Sidebar header */
        .sidebar-header {
            padding: 20px;
            font-size: 1.4em;
            font-weight: bold;
            border-bottom: 1px solid #333;
        }

        /* Sidebar content padding */
        .sidebar-content {
            padding: 20px;
        }

        /* Spacing for sidebar sections */
        .sidebar-section {
            margin-bottom: 30px;
        }

        /* Title for sidebar sections */
        .sidebar-section-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Individual items/links in the sidebar */
        .sidebar-item {
            padding: 10px;
            cursor: pointer;
            background-color: #2d364a; /* Slightly lighter blue */
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.2s ease; /* Smooth hover */
        }

        .sidebar-item:hover {
            background-color: #3a4967; /* Hover effect */
        }

        /* Styling for links within sidebar items */
        .sidebar-link {
            color: #fff;
            text-decoration: none;
            display: block;
        }

        /* Main content header */
        .module-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            background-color: #1c2639; /* Match sidebar */
            color: #fff;
        }

        /* Module title in the header */
        .module-title {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        /* Optional icon styling */
        .module-title i {
            margin-right: 10px;
        }

        /* Area below the main header, for buttons/status */
        .module-description {
            padding: 10px 20px;
            color: #aaa;
            background-color: #1c2639; /* Match sidebar */
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            align-items: center;
            border-bottom: 1px solid #333; /* Separator */
        }

        /* Main content scrolling area */
        .module-content {
            padding: 20px;
            background-color: #fff;
            margin: 0;
            color: #333;
            flex: 1; /* Take remaining vertical space */
            overflow-y: auto; /* Enable vertical scroll */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Custom scrollbar for module content */
        .module-content::-webkit-scrollbar {
            width: 8px;
            background-color: #f5f5f5;
        }

        .module-content::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 4px;
        }

        .module-content::-webkit-scrollbar-thumb:hover {
            background-color: #888;
        }

        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
            background-color: transparent; /* Blend with sidebar */
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white */
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* General button styling */
        .btn {
            background-color: #4eca8b; /* Green */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background-color: #3db97a; /* Darker green */
        }

        /* Secondary button styling */
        .btn-secondary {
            background-color: #6c757d; /* Gray */
        }

        .btn-secondary:hover {
            background-color: #5a6268; /* Darker gray */
        }

        /* Container for header actions (total cost) */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between elements if more are added */
        }

        /* Table styling */
        .module-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed; /* Crucial for fixed column widths */
        }

        /* Table header and data cells */
        .module-table th,
        .module-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            overflow: hidden; /* Prevent content overflow */
            white-space: nowrap; /* Prevent text wrapping */
            text-overflow: ellipsis; /* Show ellipsis (...) if text overflows */
        }

        /* Column width definitions for Foundations Steel table */
        .module-table th:nth-child(1), /* Description */
        .module-table td:nth-child(1) {
            width: 20%;
            white-space: normal; /* Allow description to wrap */
        }

        .module-table th:nth-child(2), /* Length */
        .module-table td:nth-child(2) {
            width: 10%;
        }

        .module-table th:nth-child(3), /* Width */
        .module-table td:nth-child(3) {
            width: 10%;
        }

        .module-table th:nth-child(4), /* Rows */
        .module-table td:nth-child(4) {
            width: 10%;
        }

        .module-table th:nth-child(5), /* Qty */
        .module-table td:nth-child(5) {
            width: 10%;
        }

        .module-table th:nth-child(6), /* Total Length */
        .module-table td:nth-child(6) {
            width: 15%;
            text-align: right;
        }

        .module-table th:nth-child(7), /* Fixer or Labour */
        .module-table td:nth-child(7) {
            width: 15%;
        }

        .module-table th:nth-child(8), /* Cost */
        .module-table td:nth-child(8) {
            width: 15%;
            text-align: right;
        }

        /* Table header specific styling */
        .module-table th {
            background-color: #f2f2f2; /* Light gray background */
            font-weight: bold;
            position: relative; /* For sort arrows */
        }

        /* Section header styling */
        .section-header {
            background-color: #808080; /* Gray background */
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            margin-top: 20px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        /* Parameters input styling */
        .parameters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .parameter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .parameter-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .parameter-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }

        /* Alternating row colors */
        .module-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Row hover effect */
        .module-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Input fields within table cells */
        .module-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid transparent; /* Invisible border */
            background-color: transparent; /* Blend with cell */
            font-size: inherit; /* Match cell font size */
            font-family: inherit;
        }

        /* Dropdown styling */
        .module-table select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: inherit;
            font-family: inherit;
            border-radius: 3px;
        }

        /* Style for read-only inputs */
        .module-table input:read-only {
            color: #555; /* Slightly dimmer text */
            cursor: default;
        }

        /* Input focus styling */
        .module-table input:focus {
            border: 1px solid #4eca8b; /* Highlight border on focus */
            background-color: #fff; /* White background on focus */
            outline: none; /* Remove default outline */
        }

        /* Number input alignment */
        .module-table input[type="number"] {
            text-align: right;
        }

        /* Currency cell alignment */
        .module-table .currency {
            text-align: right;
        }

        /* Table footer row styling */
        .module-table .footer-row {
            font-weight: bold;
            background-color: #e9e9e9; /* Slightly darker gray */
        }

        /* Specific styling for the quantity cell background */
        .module-table .qty-cell {
            background-color: #f0faf3; /* Light green background */
        }

        /* Checkbox cell alignment */
        .checkbox-cell {
            text-align: center;
            vertical-align: middle; /* Center checkbox vertically */
        }

        /* Checkbox styling */
        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            vertical-align: middle; /* Align with text if any */
        }

        /* Save status indicator styling */
        #save-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
            transition: opacity 0.3s;
        }

        /* Add item button styling */
        .add-item-btn {
            margin-top: 10px;
            display: inline-block;
        }

        /* Table header sorting styles */
        .sort-header {
            cursor: pointer;
        }

        .sort-header::after { /* Default sort arrow (down) */
            content: "▼";
            font-size: 0.8em;
            margin-left: 5px;
            opacity: 0.3; /* Dimmed by default */
            display: inline-block; /* Ensure space is reserved */
        }

        .sort-header.sorted-asc::after { /* Up arrow when sorted ascending */
            content: "▲";
            opacity: 1; /* Fully visible */
        }

        .sort-header.sorted-desc::after { /* Down arrow when sorted descending */
            content: "▼";
            opacity: 1; /* Fully visible */
        }

        /* Debug panel styling */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999; /* Ensure it's on top */
            display: none; /* Hidden by default */
            max-height: 200px; /* Limit height */
            overflow-y: auto; /* Allow scrolling if content exceeds max height */
        }
         /* Debug toggle button styling */
         #debug-toggle-btn {
             position: fixed;
             bottom: 10px;
             right: 10px;
             z-index: 10000; /* Above debug panel */
             padding: 5px 10px;
             background: #333;
             color: white;
             border: none;
             border-radius: 3px;
             cursor: pointer;
             font-size: 12px;
         }

        /* Section totals styling */
        .section-totals {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            margin-bottom: 25px;
            font-weight: bold;
        }

        .section-totals div {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    
    <div class="sidebar">
        
        <div class="sidebar-header">Foundations Steel</div>

        <div class="sidebar-content">
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="return-to-dashboard">Return to Dashboard</a>
                </div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="goto-foundations-excavation">Go to Foundations Excavation</a>
                </div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="goto-foundations-concrete">Go to Foundations Concrete</a>
                </div>
            </div>

            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Actions</div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="add-custom-item">Add Custom Item</a>
                </div>
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" id="save-module-data">Save Data</a>
                </div>
            </div>
        </div>
    </div>

    
    <div class="main-content">
        
        <div class="module-header">
            <div class="module-title">
                <i>F</i> <span id="module-title-text">Foundations Steel</span>
            </div>
            
            <div id="client-name-display" style="margin-left: 20px;">Client: Loading...</div>
            <div class="header-actions">
                
                <div id="total-module-cost">
                    Total Steel Cost: R0.00
                </div>
            </div>
        </div>

        
        <div class="module-description">
            <div style="display: flex; justify-content: flex-end; align-items: center; width: 100%;">
                
                <div id="save-status"></div>
                
                <button id="save-btn" class="btn">Save</button>
                
                <button id="return-btn" class="btn btn-secondary" style="margin-left: 10px;">Return to Dashboard</button>
            </div>
        </div>

        
        <div class="module-content">
            <!-- Global parameters -->
            <div class="parameters-container">
                <div class="parameter-group">
                    <label class="parameter-label" for="labour-contingency">Labour Contingency</label>
                    <input type="number" id="labour-contingency" class="parameter-input currency-input" value="0" min="0" step="100">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label" for="sundries">Sundries</label>
                    <input type="number" id="sundries" class="parameter-input currency-input" value="0" min="0" step="100">
                </div>
            </div>

            <!-- Steel table -->
            <table class="module-table" id="steel-table">
                <thead>
                    <tr>
                        <th class="sort-header" data-sort="description">Foundations Steel</th>
                        <th class="sort-header" data-sort="length">Length</th>
                        <th class="sort-header" data-sort="width">Width</th>
                        <th class="sort-header" data-sort="rows">Rows</th>
                        <th class="sort-header" data-sort="qty">Qty</th>
                        <th class="sort-header" data-sort="totalLength">Total Length</th>
                        <th>Fixer or Labour</th>
                        <th class="sort-header" data-sort="cost">Cost</th>
                    </tr>
                </thead>
                <tbody id="steel-table-body">
                    <!-- Table rows will be added dynamically by JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Total Steel Length (m)</td>
                        <td class="currency" id="length-total">0.00</td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Material Cost</td>
                        <td colspan="2"></td>
                        <td class="currency" id="material-total">R0.00</td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Fixer Cost</td>
                        <td colspan="2"></td>
                        <td class="currency" id="fixer-total">R0.00</td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Labour Cost</td>
                        <td colspan="2"></td>
                        <td class="currency" id="labour-total">R0.00</td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Labour Contingency</td>
                        <td colspan="2"></td>
                        <td class="currency" id="contingency-total">R0.00</td>
                    </tr>
                    <tr class="footer-row">
                        <td colspan="5" style="text-align: right;">Total Steel Cost</td>
                        <td colspan="2"></td>
                        <td class="currency" id="table-total">R0.00</td>
                    </tr>
                </tfoot>
            </table>

            <!-- Add custom item button -->
            <button id="add-item-btn" class="btn add-item-btn">Add Custom Item</button>
        </div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel" id="debug-panel"></div>
     
    <button id="debug-toggle-btn" style="display: none;">Debug</button>


    <script>
        // =====================================================================
        // MODULE CONFIGURATION - FOUNDATIONS STEEL
        // =====================================================================
        const MODULE = {
            id: 'foundations-steel', // Unique ID for this module
            title: 'Foundations Steel', // User-facing title
            defaultItems: [ // Items specific to the Foundations Steel module
                { 
                    id: 'steel-house-double', 
                    description: 'House Double', 
                    length: 0, 
                    width: 1, 
                    rows: 4, 
                    qty: 0,
                    method: 'Fixer', // Fixer or Labour
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-house-single', 
                    description: 'House Single', 
                    length: 0, 
                    width: 1, 
                    rows: 4, 
                    qty: 0,
                    method: 'Labour', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-house-retainer-walls', 
                    description: 'House Retainer Walls', 
                    length: 0, 
                    width: 2, 
                    rows: 4, 
                    qty: 1,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-boundary-walls', 
                    description: 'Boundary Walls', 
                    length: 0, 
                    width: 1, 
                    rows: 4, 
                    qty: 1,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-external-retaining', 
                    description: 'External Retaining', 
                    length: 0, 
                    width: 2, 
                    rows: 4, 
                    qty: 1,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-patios', 
                    description: 'Patio\'s', 
                    length: 0, 
                    width: 1, 
                    rows: 4, 
                    qty: 1,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-walkways', 
                    description: 'Walkways', 
                    length: 0, 
                    width: 1, 
                    rows: 4, 
                    qty: 0,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-pool', 
                    description: 'Pool', 
                    length: 0, 
                    width: 0, 
                    rows: 4, 
                    qty: 0,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                },
                { 
                    id: 'steel-columns', 
                    description: 'Columns', 
                    length: 0, 
                    width: 1.5, 
                    rows: 0, 
                    qty: 0,
                    method: 'Fixer', 
                    editable: true,
                    custom: false
                }
            ],
            // Pricing constants
            pricing: {
                steelRate: 14.50,            // R14.50 per meter of steel
                fixerRate: 9.50,             // R9.50 per meter for fixer labor
                labourRate: 8.00,            // R8.00 per meter for regular labor
                labourContingencyPercent: 10 // 10% of total cost for contingency
            }
        };

        // =====================================================================
        // MODULE STATE & UTILITIES
        // =====================================================================

        // Holds the current data for this module instance
        let moduleData = {
            items: [],
            parameters: {
                labourContingency: 0,
                sundries: 0
            },
            totals: {
                totalLength: 0,
                materialCost: 0,
                fixerCost: 0,
                labourCost: 0,
                contingencyCost: 0,
                totalCost: 0
            },
            lastModified: new Date().toISOString()
        };

        // Stores the function to cancel the auto-save timer
        let cancelAutoSave = null;

        // Flag to enable/disable the debug panel
        const DEBUG = true; // Set to false to hide debug panel and button

        // Reference to the table body for frequent updates
        let tableBodyElement = null;

        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`[${MODULE.id}] DOM loaded, initializing module`);

            // Cache table body element
            tableBodyElement = document.getElementById('steel-table-body');
            if (!tableBodyElement) {
                console.error(`[${MODULE.id}] Critical error: Table body element #steel-table-body not found!`);
                return; // Stop initialization if table body is missing
            }

            // Set up debug panel and toggle button if DEBUG is true
            if (DEBUG) {
                setupDebugPanel();
            }

            // Update titles based on MODULE configuration
            updateModuleTitles();

            // --- Access Control & Client Loading ---
            // Ensure the module was accessed correctly (e.g., from the dashboard with a client selected)
            const validAccess = window.ConstructionApp.ModuleUtils.checkModuleAccess();
            if (!validAccess) {
                console.warn(`[${MODULE.id}] Invalid access detected, redirecting via ModuleUtils.`);
                // ModuleUtils.checkModuleAccess handles the redirection if needed
                return; // Stop initialization if access is invalid
            }

            // Get the currently selected client from the ClientManager
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            if (!client) {
                console.error(`[${MODULE.id}] No client data found. Returning to dashboard.`);
                window.ConstructionApp.ModuleUtils.showErrorMessage('No client selected. Please return to the dashboard and select a client.');
                // Redirect back to dashboard if no client is active
                setTimeout(() => window.ConstructionApp.ModuleUtils.returnToDashboard(MODULE.id, moduleData, false), 500); // Delay slightly for message
                return;
            }

            // Display the client's name in the header
            const clientNameDisplay = document.getElementById('client-name-display');
            if(clientNameDisplay) {
                clientNameDisplay.textContent = `Client: ${client.name}`;
            } else {
                console.warn(`[${MODULE.id}] Element #client-name-display not found.`);
            }

            // --- Setup UI Components & Data ---
            // Initialize the save status indicator (e.g., shows "Saved", "Saving...", "Unsaved")
            window.ConstructionApp.ModuleUtils.initSaveStatus('save-status');

            // Attach event listeners to buttons, links, etc.
            setupEventListeners();

            // Set up parameter event listeners
            setupParameterListeners();

            // Load existing module data for the client or initialize with defaults
            initModuleData(); // This function now calls updateUI internally

            // Set up tracking for unsaved changes on table inputs
            window.ConstructionApp.ModuleUtils.setupChangeTracking('.module-table input, .module-table select, .parameter-input');

            // --- Auto-Save & Final Steps ---
            // Set up automatic saving every 2 minutes (120,000 ms)
            cancelAutoSave = window.ConstructionApp.ModuleUtils.setupAutoSave(saveModuleData, 120000);

            // Enable table column sorting
            setupTableSorting();

            // Initial update for the debug panel if enabled
            if (DEBUG) {
                updateDebugPanel();
            }

            console.log(`[${MODULE.id}] Initialization complete.`);
        });

        // =====================================================================
        // UI UPDATE FUNCTIONS
        // =====================================================================

        /**
         * Updates various titles on the page based on MODULE.title.
         */
        function updateModuleTitles() {
            document.title = `${MODULE.title} - Construction Estimator`;
            const sidebarHeader = document.querySelector('.sidebar-header');
            if (sidebarHeader) sidebarHeader.textContent = MODULE.title;

            const moduleTitleText = document.getElementById('module-title-text');
            if (moduleTitleText) moduleTitleText.textContent = MODULE.title;

            const totalModuleCost = document.getElementById('total-module-cost');
            if (totalModuleCost) totalModuleCost.textContent = `Total Steel Cost: R0.00`; // Initial value
        }

        /**
         * Renders the items from moduleData into the table.
         * Clears the existing table body and adds a row for each item.
         */
        function updateUI() {
            if (!tableBodyElement) {
                console.error(`[${MODULE.id}] Cannot update UI: Table body element not found.`);
                return;
            }
            console.log(`[${MODULE.id}] Updating UI with ${moduleData.items.length} items.`);
            tableBodyElement.innerHTML = ''; // Clear existing rows efficiently

            // Update parameter inputs
            document.getElementById('labour-contingency').value = moduleData.parameters.labourContingency;
            document.getElementById('sundries').value = moduleData.parameters.sundries;

            // Add a row for each item in the moduleData
            moduleData.items.forEach(item => {
                addTableRow(item);
            });

            // Recalculate and display totals
            calculateTotals();

            // Update the debug panel if it's enabled
            if (DEBUG) {
                updateDebugPanel();
            }
        }

        /**
         * Creates and adds a single table row (<tr>) to the table body for a given item.
         * @param {object} item - The item object from moduleData.items.
         */
        function addTableRow(item) {
            if (!tableBodyElement) {
                console.error(`[${MODULE.id}] Cannot add table row: Table body element not found.`);
                return;
            }
            const row = document.createElement('tr');
            row.setAttribute('data-item-id', item.id); // Store item ID for easy reference

            // Calculate total length
            const totalLength = calculateTotalLength(item);

            // Set the inner HTML of the row with table cells (<td>)
            row.innerHTML = `
                <td> 
                    <input type="text" class="description-input" value="${item.description || ''}" ${item.editable ? '' : 'readonly'}>
                </td>
                <td> 
                    <input type="number" class="length-input" value="${item.length}" min="0" step="0.1" data-item-id="${item.id}">
                </td>
                <td> 
                    <input type="number" class="width-input" value="${item.width}" min="0" step="0.1" data-item-id="${item.id}">
                </td>
                <td> 
                    <input type="number" class="rows-input" value="${item.rows}" min="0" step="1" data-item-id="${item.id}">
                </td>
                <td class="qty-cell"> 
                    <input type="number" class="qty-input" value="${item.qty}" min="0" step="1" data-item-id="${item.id}">
                </td>
                <td class="total-length-cell">
                    ${totalLength.toFixed(2)}
                </td>
                <td> 
                    <select class="method-select" data-item-id="${item.id}">
                        <option value="Fixer" ${item.method === 'Fixer' ? 'selected' : ''}>Fixer</option>
                        <option value="Labour" ${item.method === 'Labour' ? 'selected' : ''}>Labour</option>
                    </select>
                </td>
                <td class="cost-cell currency"> 
                    ${window.ConstructionApp.ModuleUtils.formatCurrency(calculateRowCost(item))}
                </td>
            `;

            tableBodyElement.appendChild(row);

            // Add event listeners to the inputs in this new row AFTER appending
            setupRowInputHandlers(row, item);
        }

        // =====================================================================
        // DATA INITIALIZATION & MANAGEMENT
        // =====================================================================

        /**
         * Loads module data from the current client or initializes with defaults.
         */
        function initModuleData() {
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            // Should always have a client at this point due to checks in DOMContentLoaded
            if (!client) {
                console.error(`[${MODULE.id}] Critical error during initModuleData: Client object disappeared.`);
                return; // Prevent further errors
            }

            // Check if the client object has saved data for this specific module
            const savedData = client.moduleData?.[MODULE.id]; // Optional chaining

            if (savedData && savedData.items && Array.isArray(savedData.items)) {
                console.log(`[${MODULE.id}] Restoring saved data. Items count: ${savedData.items.length}`);
                // Restore data from the saved state
                moduleData = { ...savedData }; // Shallow copy is okay here if items are handled next
                // Ensure items array exists and is an array, just in case saved data is corrupted
                if (!moduleData.items || !Array.isArray(moduleData.items)) {
                    console.warn(`[${MODULE.id}] Saved items data was invalid or missing. Resetting items.`);
                    moduleData.items = [];
                }
                // Ensure parameters object exists
                if (!moduleData.parameters) {
                    moduleData.parameters = {
                        labourContingency: 0,
                        sundries: 0
                    };
                }
                // Ensure totals object exists
                if (!moduleData.totals) {
                    moduleData.totals = {
                        totalLength: 0,
                        materialCost: 0,
                        fixerCost: 0,
                        labourCost: 0,
                        contingencyCost: 0,
                        totalCost: 0
                    };
                }
                // Merge saved items with default items to handle potential updates/new defaults
                mergeWithDefaultItems();
            } else {
                console.log(`[${MODULE.id}] No saved data found or data invalid, initializing with defaults.`);
                // No valid saved data, start with a deep copy of the default items
                moduleData.items = JSON.parse(JSON.stringify(MODULE.defaultItems));
                moduleData.parameters = {
                    labourContingency: 0,
                    sundries: 0
                };
                moduleData.totals = {
                    totalLength: 0,
                    materialCost: 0,
                    fixerCost: 0,
                    labourCost: 0,
                    contingencyCost: 0,
                    totalCost: 0
                };
                moduleData.lastModified = new Date().toISOString();
            }

            // Render the initial UI based on the loaded/default data
            updateUI();
        }

        /**
         * Merges saved items with default items. Ensures all default items are present,
         * uses saved values if available, and preserves custom items.
         */
        function mergeWithDefaultItems() {
            console.log(`[${MODULE.id}] Merging saved items with default items.`);
            const savedItemsMap = new Map(moduleData.items.map(item => [item.id, item]));
            const mergedItems = [];

            // Process default items: Use saved version if exists, otherwise use default
            MODULE.defaultItems.forEach(defaultItem => {
                const savedItem = savedItemsMap.get(defaultItem.id);
                if (savedItem) {
                    // Use saved item, but ensure critical default properties (like description, editable status) are preserved
                    mergedItems.push({
                        ...savedItem, // Take most properties from saved
                        description: defaultItem.description, // Ensure description matches default
                        editable: defaultItem.editable,     // Ensure editable status matches default
                        custom: false // Mark explicitly as not custom
                    });
                    savedItemsMap.delete(defaultItem.id); // Remove from map as it's processed
                } else {
                    // Default item not found in saved data, add the default version
                    console.log(`[${MODULE.id}] Adding new default item: ${defaultItem.id}`);
                    mergedItems.push({ ...defaultItem, custom: false }); // Deep copy default item
                }
            });

            // Add remaining items from the map (these are custom items)
            savedItemsMap.forEach(customItem => {
                if (customItem.custom) { // Only add items explicitly marked as custom or those not in defaults
                    console.log(`[${MODULE.id}] Preserving custom item: ${customItem.id}`);
                    mergedItems.push(customItem);
                } else {
                    // This case might happen if a default item was removed from the config
                    // but still exists in saved data. Decide whether to keep or discard.
                    console.warn(`[${MODULE.id}] Found saved item not in defaults and not marked custom: ${customItem.id}. Preserving it.`);
                    mergedItems.push({...customItem, custom: true}); // Mark as custom for safety
                }
            });

            moduleData.items = mergedItems;
            console.log(`[${MODULE.id}] Merge complete. Final items count: ${moduleData.items.length}`);
        }

        /**
         * Adds a new, empty custom item to the data and UI.
         */
        function addCustomItem() {
            console.log(`[${MODULE.id}] Adding new custom item.`);
            // Generate a unique ID for the new item
            const newId = `custom-${Date.now()}-${Math.random().toString(16).slice(2)}`;

            // Create the new item object
            const newItem = {
                id: newId,
                description: 'New Custom Item', // Default description
                length: 0,
                width: 1,
                rows: 4,
                qty: 0,
                method: 'Fixer',
                editable: true, // Custom items are always editable
                custom: true    // Mark as a custom item
            };

            // Add the new item to the module's data
            moduleData.items.push(newItem);

            // Add a corresponding row to the table UI
            addTableRow(newItem);

            // Mark that there are unsaved changes
            window.ConstructionApp.ModuleUtils.markUnsavedChanges();

            // Recalculate totals to include the new item
            calculateTotals();

            // Focus the description input of the newly added row
            const newRow = tableBodyElement.querySelector(`tr[data-item-id="${newId}"]`);
            if (newRow) {
                const descInput = newRow.querySelector('.description-input');
                if (descInput) {
                    descInput.focus();
                    descInput.select(); // Select the text for easy editing
                }
            }
        }

        // =====================================================================
        // EVENT HANDLING & CALCULATIONS
        // =====================================================================

        /**
         * Sets up event listeners for the global parameter inputs.
         */
        function setupParameterListeners() {
            const labourContingencyInput = document.getElementById('labour-contingency');
            const sundriesInput = document.getElementById('sundries');

            if (labourContingencyInput) {
                labourContingencyInput.addEventListener('input', function() {
                    moduleData.parameters.labourContingency = parseFloat(this.value) || 0;
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                    calculateTotals();
                });
            }

            if (sundriesInput) {
                sundriesInput.addEventListener('input', function() {
                    moduleData.parameters.sundries = parseFloat(this.value) || 0;
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges();
                    calculateTotals();
                });
            }

            // Format currency inputs on blur
            const currencyInputs = document.querySelectorAll('.currency-input');
            currencyInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    const value = parseFloat(this.value) || 0;
                    this.value = value;
                });
            });
        }

        /**
         * Sets up input event handlers for a specific table row.
         * @param {HTMLTableRowElement} row - The table row element.
         * @param {object} item - The corresponding item object from moduleData.
         */
        function setupRowInputHandlers(row, item) {
            // --- Description Input (only if editable) ---
            const descInput = row.querySelector('.description-input');
            if (descInput && item.editable) {
                descInput.addEventListener('input', () => {
                    updateItemFromRow(row, item); // Update data model
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges(); // Mark changes
                });
            }

            // --- Length, Width, Rows Inputs ---
            const dimensionInputs = row.querySelectorAll('.length-input, .width-input, .rows-input');
            dimensionInputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateItemFromRow(row, item); // Update data model
                    updateRowCalculations(row, item); // Update row calculations
                    calculateTotals(); // Update overall totals
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges(); // Mark changes
                });
            });

            // --- Quantity Input ---
            const qtyInput = row.querySelector('.qty-input');
            if (qtyInput) {
                qtyInput.addEventListener('input', () => {
                    updateItemFromRow(row, item); // Update data model
                    updateRowCalculations(row, item); // Update row calculations
                    calculateTotals(); // Update overall totals
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges(); // Mark changes
                });
            }

            // --- Method Select ---
            const methodSelect = row.querySelector('.method-select');
            if (methodSelect) {
                methodSelect.addEventListener('change', () => {
                    updateItemFromRow(row, item); // Update data model
                    updateRowCalculations(row, item); // Update cost calculations
                    calculateTotals(); // Update overall totals
                    window.ConstructionApp.ModuleUtils.markUnsavedChanges(); // Mark changes
                });
            }
        }

        /**
         * Updates the corresponding item object in moduleData based on the input values in a table row.
         * @param {HTMLTableRowElement} row - The table row element containing the inputs.
         * @param {object} item - The item object in moduleData to update.
         */
        function updateItemFromRow(row, item) {
            // Find inputs within the row
            const descInput = row.querySelector('.description-input');
            const lengthInput = row.querySelector('.length-input');
            const widthInput = row.querySelector('.width-input');
            const rowsInput = row.querySelector('.rows-input');
            const qtyInput = row.querySelector('.qty-input');
            const methodSelect = row.querySelector('.method-select');

            // Update item properties from input values, respecting editability
            if (descInput && item.editable) {
                item.description = descInput.value;
            }
            if (lengthInput) {
                item.length = parseFloat(lengthInput.value) || 0;
            }
            if (widthInput) {
                item.width = parseFloat(widthInput.value) || 0;
            }
            if (rowsInput) {
                item.rows = parseInt(rowsInput.value) || 0;
            }
            if (qtyInput) {
                item.qty = parseInt(qtyInput.value) || 0;
            }
            if (methodSelect) {
                item.method = methodSelect.value;
            }

            moduleData.lastModified = new Date().toISOString();
            if (DEBUG) updateDebugPanel();
        }

        /**
         * Updates the calculated values for a single row (total length, cost).
         * @param {HTMLTableRowElement} row - The table row element.
         * @param {object} item - The corresponding item object from moduleData.
         */
        function updateRowCalculations(row, item) {
            const totalLengthCell = row.querySelector('.total-length-cell');
            const costCell = row.querySelector('.cost-cell');
            
            if (!totalLengthCell || !costCell) return;

            // Calculate total length
            const totalLength = calculateTotalLength(item);
            totalLengthCell.textContent = totalLength.toFixed(2);
            
            // Calculate cost for this item
            const cost = calculateRowCost(item);
            costCell.textContent = window.ConstructionApp.ModuleUtils.formatCurrency(cost);
        }

        /**
         * Calculates the total steel length for an item.
         * @param {object} item - The item object from moduleData.
         * @returns {number} The calculated total length.
         */
        function calculateTotalLength(item) {
            // For reinforcement steel:
            // Total Length = Length * (Width Factor) * Rows * Qty
            // Width factor is calculated from width itself (usually adding some overlap)
            
            // Simple calculation: the total length is length + width (for sides) * rows * qty
            const factor = item.width > 0 ? 2 : 1; // If width is 0, don't multiply
            return (item.length + (item.width * factor)) * item.rows * Math.max(1, item.qty);
        }

        /**
         * Calculates the cost for a single steel item.
         * @param {object} item - The item object from moduleData.
         * @returns {number} The calculated cost for the item.
         */
        function calculateRowCost(item) {
            const totalLength = calculateTotalLength(item);
            
            // Material cost is always the steel rate times the total length
            const materialCost = totalLength * MODULE.pricing.steelRate;
            
            // Labor cost depends on method
            let laborCost = 0;
            if (item.method === 'Fixer') {
                laborCost = totalLength * MODULE.pricing.fixerRate;
            } else { // Labour
                laborCost = totalLength * MODULE.pricing.labourRate;
            }
            
            return materialCost + laborCost;
        }

        /**
         * Recalculates the total costs for the entire module and updates the UI.
         */
        function calculateTotals() {
            let totalLength = 0;
            let materialCost = 0;
            let fixerCost = 0;
            let labourCost = 0;
            
            // Calculate totals by item
            moduleData.items.forEach(item => {
                const itemTotalLength = calculateTotalLength(item);
                totalLength += itemTotalLength;
                
                // Material cost is always the steel rate times the total length
                materialCost += itemTotalLength * MODULE.pricing.steelRate;
                
                // Labor cost depends on method
                if (item.method === 'Fixer') {
                    fixerCost += itemTotalLength * MODULE.pricing.fixerRate;
                } else { // Labour
                    labourCost += itemTotalLength * MODULE.pricing.labourRate;
                }
            });
            
            // Calculate contingency cost
            const contingencyCost = moduleData.parameters.labourContingency;
            
            // Calculate total cost
            const totalCost = materialCost + fixerCost + labourCost + contingencyCost + moduleData.parameters.sundries;
            
            // Update moduleData
            moduleData.totals = {
                totalLength,
                materialCost,
                fixerCost,
                labourCost,
                contingencyCost,
                totalCost
            };
            
            // Update table footer
            document.getElementById('length-total').textContent = totalLength.toFixed(2);
            document.getElementById('material-total').textContent = window.ConstructionApp.ModuleUtils.formatCurrency(materialCost);
            document.getElementById('fixer-total').textContent = window.ConstructionApp.ModuleUtils.formatCurrency(fixerCost);
            document.getElementById('labour-total').textContent = window.ConstructionApp.ModuleUtils.formatCurrency(labourCost);
            document.getElementById('contingency-total').textContent = window.ConstructionApp.ModuleUtils.formatCurrency(contingencyCost);
            document.getElementById('table-total').textContent = window.ConstructionApp.ModuleUtils.formatCurrency(totalCost);
            
            // Update header total
            const headerTotalElement = document.getElementById('total-module-cost');
            if (headerTotalElement) {
                headerTotalElement.textContent = `Total Steel Cost: ${window.ConstructionApp.ModuleUtils.formatCurrency(totalCost)}`;
            }

            if (DEBUG) {
                updateDebugPanel();
            }
        }

        // =====================================================================
        // EVENT LISTENERS SETUP
        // =====================================================================

        /**
         * Attaches event listeners to static elements like buttons and links.
         */
        function setupEventListeners() {
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) saveBtn.addEventListener('click', () => saveModuleData(false));

            const saveSidebarLink = document.getElementById('save-module-data');
            if (saveSidebarLink) {
                saveSidebarLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    saveModuleData(false);
                });
            }

            const returnBtn = document.getElementById('return-btn');
            if(returnBtn) returnBtn.addEventListener('click', returnToDashboard);

            const returnSidebarLink = document.getElementById('return-to-dashboard');
            if (returnSidebarLink) {
                returnSidebarLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    returnToDashboard();
                });
            }

            const addItemBtn = document.getElementById('add-item-btn');
            if (addItemBtn) addItemBtn.addEventListener('click', addCustomItem);

            const addSidebarLink = document.getElementById('add-custom-item');
            if (addSidebarLink) {
                addSidebarLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    addCustomItem();
                });
            }

            // Navigate to excavation module
            const gotoExcavationLink = document.getElementById('goto-foundations-excavation');
            if (gotoExcavationLink) {
                gotoExcavationLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToFoundationsExcavation();
                });
            }

            // Navigate to concrete module
            const gotoConcreteLink = document.getElementById('goto-foundations-concrete');
            if (gotoConcreteLink) {
                gotoConcreteLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToFoundationsConcrete();
                });
            }
        }

        // =====================================================================
        // TABLE SORTING
        // =====================================================================

        /**
         * Adds click listeners to sortable table headers.
         */
        function setupTableSorting() {
            const sortHeaders = document.querySelectorAll('.sort-header');
            sortHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    if (sortBy) {
                        sortTable(sortBy, this);
                    }
                });
            });
        }

        /**
         * Sorts the moduleData.items array and updates the UI.
         * @param {string} sortBy - The key of the item property to sort by.
         * @param {HTMLTableCellElement} header - The clicked header element (<th>).
         */
        function sortTable(sortBy, header) {
            let sortAsc = true;
            const isCurrentlyAsc = header.classList.contains('sorted-asc');
            const isCurrentlyDesc = header.classList.contains('sorted-desc');

            document.querySelectorAll('.sort-header').forEach(h => {
                h.classList.remove('sorted-asc', 'sorted-desc');
            });

            if (isCurrentlyAsc) {
                sortAsc = false;
                header.classList.add('sorted-desc');
            } else {
                sortAsc = true;
                header.classList.add('sorted-asc');
            }
            console.log(`[${MODULE.id}] Sorting by ${sortBy}, direction: ${sortAsc ? 'ASC' : 'DESC'}`);

            moduleData.items.sort((a, b) => {
                let aValue, bValue;
                switch (sortBy) {
                    case 'description':
                        aValue = (a.description || '').toLowerCase();
                        bValue = (b.description || '').toLowerCase();
                        break;
                    case 'length': 
                        aValue = a.length; 
                        bValue = b.length; 
                        break;
                    case 'width': 
                        aValue = a.width; 
                        bValue = b.width; 
                        break;
                    case 'rows': 
                        aValue = a.rows; 
                        bValue = b.rows; 
                        break;
                    case 'qty': 
                        aValue = a.qty; 
                        bValue = b.qty; 
                        break;
                    case 'totalLength':
                        aValue = calculateTotalLength(a);
                        bValue = calculateTotalLength(b);
                        break;
                    case 'cost':
                        aValue = calculateRowCost(a);
                        bValue = calculateRowCost(b);
                        break;
                    default: 
                        return 0;
                }
                let comparison = 0;
                if (aValue < bValue) comparison = -1;
                else if (aValue > bValue) comparison = 1;
                return sortAsc ? comparison : (comparison * -1);
            });
            updateUI();
        }

        // =====================================================================
        // DATA PERSISTENCE (SAVING)
        // =====================================================================

        /**
         * Saves the current module data to the client object and triggers persistence.
         * @param {boolean} [isAutoSave=false] - Flag indicating if the save was triggered by auto-save.
         */
        function saveModuleData(isAutoSave = false) {
            const actionType = isAutoSave ? 'Auto-saving' : 'Saving';
            console.log(`[${MODULE.id}] ${actionType} module data...`);
            moduleData.lastModified = new Date().toISOString();
            window.ConstructionApp.ModuleUtils.updateSaveStatus('saving');
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            if (!client) {
                console.error(`[${MODULE.id}] Cannot save: Client object not found.`);
                window.ConstructionApp.ModuleUtils.updateSaveStatus('error', 'Error: Client not found');
                window.ConstructionApp.ModuleUtils.showErrorMessage('Could not save data: Client information is missing.');
                return;
            }
            if (!client.moduleData) client.moduleData = {};
            client.moduleData[MODULE.id] = JSON.parse(JSON.stringify(moduleData));
            client.lastModified = new Date().toISOString();
            window.ConstructionApp.ClientManager.setCurrentClient(client);
            console.log(`[${MODULE.id}] Updated client object in memory/sessionStorage.`);
            window.ConstructionApp.ClientManager.saveModuleData(MODULE.id, moduleData, (success, error) => {
                if (success) {
                    const message = isAutoSave ? 'Auto-saved' : 'Saved';
                    console.log(`[${MODULE.id}] ${message} successful.`);
                    window.ConstructionApp.ModuleUtils.updateSaveStatus('saved', message);
                    if (!isAutoSave) {
                        window.ConstructionApp.ModuleUtils.showSuccessMessage(`${MODULE.title} data saved successfully!`);
                    }
                } else {
                    const errorMsg = error || 'Unknown error during save';
                    console.error(`[${MODULE.id}] Save failed:`, errorMsg);
                    window.ConstructionApp.ModuleUtils.updateSaveStatus('error', `Error: ${errorMsg}`);
                    window.ConstructionApp.ModuleUtils.showErrorMessage(`Error saving ${MODULE.title} data: ${errorMsg}`);
                }
            });
        }

        // =====================================================================
        // NAVIGATION
        // =====================================================================

        /**
         * Handles the process of returning to the dashboard, prompting to save if necessary.
         */
        function returnToDashboard() {
            console.log(`[${MODULE.id}] Initiating return to dashboard...`);
            if (window.ConstructionApp.ModuleUtils.hasUnsavedChanges()) {
                const shouldSave = confirm("You have unsaved changes. Would you like to save before returning to the dashboard?");
                if (shouldSave) {
                    console.log(`[${MODULE.id}] User chose to save before returning.`);
                    saveModuleData(false);
                    setTimeout(navigateToDashboard, 200);
                    return;
                } else {
                    console.log(`[${MODULE.id}] User chose *not* to save before returning.`);
                }
            } else {
                console.log(`[${MODULE.id}] No unsaved changes detected.`);
            }
            navigateToDashboard();
        }

        /**
         * Performs the actual navigation to the dashboard page, ensuring state is preserved.
         */
        function navigateToDashboard() {
            console.log(`[${MODULE.id}] Preparing to navigate to dashboard.`);
            if (cancelAutoSave) {
                cancelAutoSave();
                console.log(`[${MODULE.id}] Auto-save timer cancelled.`);
            }
            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            if (client) {
                if (!client.moduleData) client.moduleData = {};
                client.moduleData[MODULE.id] = JSON.parse(JSON.stringify(moduleData));
                client.lastModified = new Date().toISOString();
                window.ConstructionApp.ClientManager.setCurrentClient(client);
                console.log(`[${MODULE.id}] Client object updated with current module state before navigation.`);
            } else {
                console.warn(`[${MODULE.id}] Client object not found during navigation preparation.`);
            }
            sessionStorage.setItem('navigationState', 'returningToDashboard');
            console.log(`[${MODULE.id}] Navigation state set to 'returningToDashboard'.`);
            console.log(`[${MODULE.id}] Redirecting to index.html...`);
            window.location.href = 'index.html';
        }

        /**
         * Navigates to the Foundations Excavation module.
         */
        function navigateToFoundationsExcavation() {
            console.log(`[${MODULE.id}] Preparing to navigate to Foundations Excavation module.`);
            if (window.ConstructionApp.ModuleUtils.hasUnsavedChanges()) {
                const shouldSave = confirm("You have unsaved changes. Would you like to save before going to the Foundations Excavation module?");
                if (shouldSave) {
                    console.log(`[${MODULE.id}] User chose to save before navigating.`);
                    saveModuleData(false);
                    setTimeout(() => {
                        window.location.href = 'foundations-excavation.html';
                    }, 200);
                    return;
                }
            }
            window.location.href = 'foundations-excavation.html';
        }

        /**
         * Navigates to the Foundations Concrete module.
         */
        function navigateToFoundationsConcrete() {
            console.log(`[${MODULE.id}] Preparing to navigate to Foundations Concrete module.`);
            if (window.ConstructionApp.ModuleUtils.hasUnsavedChanges()) {
                const shouldSave = confirm("You have unsaved changes. Would you like to save before going to the Foundations Concrete module?");
                if (shouldSave) {
                    console.log(`[${MODULE.id}] User chose to save before navigating.`);
                    saveModuleData(false);
                    setTimeout(() => {
                        window.location.href = 'foundations-concrete.html';
                    }, 200);
                    return;
                }
            }
            window.location.href = 'foundations-concrete.html';
        }

        // =====================================================================
        // DEBUGGING UTILITIES
        // =====================================================================

        /**
         * Sets up the debug panel and its toggle button if DEBUG is true.
         */
        function setupDebugPanel() {
            const debugPanel = document.getElementById('debug-panel');
            const toggleBtn = document.getElementById('debug-toggle-btn');
            if (!debugPanel || !toggleBtn) {
                console.warn(`[${MODULE.id}] Debug panel or toggle button element not found.`);
                return;
            }
            toggleBtn.style.display = 'block';
            toggleBtn.addEventListener('click', function() {
                const isVisible = debugPanel.style.display === 'block';
                debugPanel.style.display = isVisible ? 'none' : 'block';
                toggleBtn.textContent = isVisible ? 'Debug' : 'Hide Debug';
                if (!isVisible) updateDebugPanel();
            });
        }

        /**
         * Updates the content of the debug panel with current state information.
         */
        function updateDebugPanel() {
            if (!DEBUG) return;
            const debugPanel = document.getElementById('debug-panel');
            if (!debugPanel || debugPanel.style.display === 'none') return;

            const client = window.ConstructionApp.ClientManager.getCurrentClient();
            let sessionClientData = null;
            try { sessionClientData = JSON.parse(sessionStorage.getItem('currentClient') || 'null'); } catch (e) {}
            const navigationState = sessionStorage.getItem('navigationState');
            const unsavedChanges = window.ConstructionApp.ModuleUtils.hasUnsavedChanges();

            let debugInfo = `
                <strong>Module ID:</strong> ${MODULE.id}<br>
                <strong>Module Title:</strong> ${MODULE.title}<br>
                <strong>Navigation State:</strong> ${navigationState || 'None'}<br>
                <hr>
                <strong>Client (Manager):</strong> ${client ? client.name : 'None'} (ID: ${client ? client.id : 'N/A'})<br>
                <strong>Client (Session):</strong> ${sessionClientData ? sessionClientData.name : 'None'} (ID: ${sessionClientData ? sessionClientData.id : 'N/A'})<br>
                <hr>
                <strong>Module Items:</strong> ${moduleData.items.length}<br>
                <strong>Labour Contingency:</strong> ${moduleData.parameters.labourContingency}<br>
                <strong>Sundries:</strong> ${moduleData.parameters.sundries}<br>
                <strong>Total Cost:</strong> ${window.ConstructionApp.ModuleUtils.formatCurrency(moduleData.totals.totalCost)}<br>
                <strong>Unsaved Changes:</strong> ${unsavedChanges ? 'Yes' : 'No'}<br>
                <strong>Last Modified:</strong> ${new Date(moduleData.lastModified).toLocaleString()}<br>
                <hr>
                <strong>First 2 Items Data:</strong><br>
                <pre style="font-size: 10px; max-height: 50px; overflow-y: auto;">${JSON.stringify(moduleData.items.slice(0, 2), null, 1)}</pre>
            `;
            debugPanel.innerHTML = debugInfo;
        }

        // =====================================================================
        // PAGE UNLOAD HANDLING
        // =====================================================================

        /**
         * Handles cleanup and prompts before the page unloads (e.g., closing tab/browser).
         */
        window.addEventListener('beforeunload', function(e) {
            console.log(`[${MODULE.id}] beforeunload event triggered.`);
            if (cancelAutoSave) {
                cancelAutoSave();
                console.log(`[${MODULE.id}] Auto-save timer cancelled on page unload.`);
            }
            if (window.ConstructionApp.ModuleUtils.hasUnsavedChanges()) {
                console.warn(`[${MODULE.id}] Unsaved changes detected on page unload attempt.`);
                const client = window.ConstructionApp.ClientManager.getCurrentClient();
                if (client) {
                    try {
                        if (!client.moduleData) client.moduleData = {};
                        client.moduleData[MODULE.id] = JSON.parse(JSON.stringify(moduleData));
                        client.lastModified = new Date().toISOString();
                        sessionStorage.setItem('currentClient', JSON.stringify(client));
                        console.log(`[${MODULE.id}] Stored client data to sessionStorage as backup during unload.`);
                    } catch (error) {
                        console.error(`[${MODULE.id}] Error storing client data to sessionStorage during unload:`, error);
                    }
                }
                const message = 'You have unsaved changes. Are you sure you want to leave?';
                e.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>
